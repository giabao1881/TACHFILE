<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tách PDF: Tách lẻ | Theo yêu cầu | Theo dung lượng + ZIP</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
    h1{font-size:20px;margin:0 0 8px}
    p{margin:0 0 14px;color:#94a3b8;line-height:1.5}
    .grid{display:grid;gap:12px;grid-template-columns:1.2fr .8fr}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    input[type="file"], input[type="text"], input[type="number"]{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:#e5e7eb;outline:none
    }
    .modes{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 4px}
    .mode{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05)
    }
    .mode input{margin-top:3px}
    .mode b{display:block}
    .hint{font-size:13px;color:#94a3b8;margin-top:6px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
    button{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background:#2563eb;color:#fff;cursor:pointer;font-weight:700
    }
    button.secondary{background:rgba(255,255,255,.08)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .progress{margin-top:14px;height:10px;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar{height:100%;width:0%;background:#22c55e;transition:width .15s ease}
    .meta{margin-top:10px;color:#cbd5e1;font-size:14px}
    .log{
      margin-top:12px;padding:12px;border-radius:12px;background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:13px;color:#e5e7eb;max-height:280px;overflow:auto
    }
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .row2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){.row2{grid-template-columns:1fr}}
    .hide{display:none !important}
    a{color:#93c5fd}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Tách PDF → nhiều file PDF → nén ZIP</h1>
      <p>
        Chọn PDF, chọn chế độ tách, bấm <b>Tách & Tải ZIP</b>.
        (Dùng <b>pdf-lib</b> + <b>JSZip</b> qua CDN.)
      </p>

      <div class="grid">
        <div>
          <input id="file" type="file" accept="application/pdf" />
          <div class="hint">PDF scan nặng có thể chạy chậm do giới hạn RAM trình duyệt.</div>
        </div>
        <div>
          <input id="zipname" type="text" placeholder="Tên ZIP (tuỳ chọn) - để trống = tự đặt" />
          <div class="hint">Ví dụ: split_ho_so_001.zip</div>
        </div>
      </div>

      <div class="modes">
        <label class="mode">
          <input type="radio" name="mode" value="single" checked />
          <div>
            <b>Chọn tách lẻ</b>
            <div class="hint">Mỗi trang 1 file PDF.</div>
          </div>
        </label>

        <label class="mode">
          <input type="radio" name="mode" value="custom" />
          <div>
            <b>Tách theo yêu cầu</b>
            <div class="hint">Bạn tự nhập nhóm trang (vd: 1-3|4-6|7,9|10).</div>
          </div>
        </label>

        <label class="mode">
          <input type="radio" name="mode" value="size" />
          <div>
            <b>Tách theo dung lượng</b>
            <div class="hint">Tự chia sao cho mỗi file ≤ X MB (trừ trang đơn lẻ quá lớn).</div>
          </div>
        </label>
      </div>

      <div id="customBox" class="row2 hide">
        <div>
          <input id="customSpec" type="text" placeholder="Nhập nhóm trang: 1-3|4-6|7,9|10" />
          <div class="hint">
            Dùng <b>|</b> để ngăn nhóm. Trong mỗi nhóm có thể dùng <b>,</b> và <b>-</b>.<br/>
            Ví dụ: <b>1-5|6-10</b> sẽ ra 2 file.
          </div>
        </div>
        <div>
          <input id="customPrefix" type="text" placeholder="Tiền tố tên file (tuỳ chọn) - vd: HO_SO" />
          <div class="hint">Nếu để trống sẽ dùng tên PDF gốc.</div>
        </div>
      </div>

      <div id="sizeBox" class="row2 hide">
        <div>
          <input id="maxMB" type="number" min="0.1" step="0.1" value="5" />
          <div class="hint">Giới hạn dung lượng mỗi file (MB). Ví dụ 5 MB.</div>
        </div>
        <div>
          <input id="sizePrefix" type="text" placeholder="Tiền tố tên file (tuỳ chọn) - vd: PART" />
          <div class="hint">Nếu để trống sẽ dùng tên PDF gốc.</div>
        </div>
      </div>

      <div class="btns">
        <button id="btnSplit" disabled>Tách & Tải ZIP</button>
        <button id="btnInfo" class="secondary" disabled>Xem thông tin PDF</button>
        <span id="status" style="color:#cbd5e1;font-size:14px"></span>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="meta" id="meta"></div>
      <div class="log" id="log"></div>

      <div class="hint" style="margin-top:10px">
        Lưu ý chế độ dung lượng: chương trình <b>đo kích thước file PDF tạo ra thực tế</b> để quyết định cắt,
        nên đa số file sẽ ≤ X MB. Nếu <b>1 trang</b> đã > X MB thì bắt buộc file đó vẫn > X MB.
      </div>
    </div>
  </div>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const fileInput = $("file");
    const zipNameInput = $("zipname");

    const customBox = $("customBox");
    const sizeBox   = $("sizeBox");
    const customSpec = $("customSpec");
    const customPrefix = $("customPrefix");
    const maxMB = $("maxMB");
    const sizePrefix = $("sizePrefix");

    const btnSplit = $("btnSplit");
    const btnInfo  = $("btnInfo");
    const statusEl = $("status");
    const metaEl   = $("meta");
    const logEl    = $("log");
    const barEl    = $("bar");

    let currentFile = null;
    let currentPdfBytes = null;
    let currentPageCount = 0;

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setBar(pct){ barEl.style.width = Math.max(0, Math.min(100, pct)) + "%"; }
    function clearLog(){ logEl.textContent = ""; metaEl.textContent = ""; setBar(0); setStatus(""); }
    function log(msg, cls){
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function getBaseName(name){ return (name || "file").replace(/\.[^.]+$/,""); }
    function padNumber(n, width){
      const s = String(n);
      return s.length >= width ? s : ("0".repeat(width - s.length) + s);
    }

    // Parse "1-3,5,7-10" => [1,2,3,5,7,8,9,10]
    function parsePageRanges(text, maxPage){
      const t = (text || "").trim();
      if (!t) return [];
      const parts = t.split(",").map(x=>x.trim()).filter(Boolean);
      const out = new Set();

      for (const part of parts){
        const m = part.match(/^(\d+)\s*-\s*(\d+)$/);
        if (m){
          let a = parseInt(m[1],10);
          let b = parseInt(m[2],10);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a > b) [a,b] = [b,a];
          for (let i=a;i<=b;i++){
            if (i>=1 && i<=maxPage) out.add(i);
          }
        } else {
          const n = parseInt(part,10);
          if (Number.isFinite(n) && n>=1 && n<=maxPage) out.add(n);
        }
      }
      return Array.from(out).sort((x,y)=>x-y);
    }

    // "1-3|4-6|7,9|10" => [[1,2,3],[4,5,6],[7,9],[10]]
    function parseGroups(spec, maxPage){
      const s = (spec || "").trim();
      if (!s) return [];
      const rawGroups = s.split("|").map(x=>x.trim()).filter(Boolean);
      const groups = [];
      for (const g of rawGroups){
        const pages = parsePageRanges(g, maxPage);
        if (pages.length) groups.push(pages);
      }
      return groups;
    }

    async function loadPdfFromFile(file){
      const buf = await file.arrayBuffer();
      currentPdfBytes = new Uint8Array(buf);
      const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
      currentPageCount = pdfDoc.getPageCount();
      return pdfDoc;
    }

    function getMode(){
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : "single";
    }

    function refreshModeUI(){
      const mode = getMode();
      customBox.classList.toggle("hide", mode !== "custom");
      sizeBox.classList.toggle("hide", mode !== "size");
    }

    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener("change", refreshModeUI);
    });
    refreshModeUI();

    fileInput.addEventListener("change", async () => {
      clearLog();
      const f = fileInput.files && fileInput.files[0];
      currentFile = f || null;

      btnSplit.disabled = true;
      btnInfo.disabled = true;

      if (!currentFile){ return; }

      setStatus("Đang đọc PDF...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("Sẵn sàng");
        btnSplit.disabled = false;
        btnInfo.disabled = false;

        metaEl.textContent =
          `Tên file: ${currentFile.name} | Dung lượng: ${(currentFile.size/1024/1024).toFixed(2)} MB | Số trang: ${currentPageCount}`;
        log("Đã tải PDF thành công.", "ok");
      } catch (e){
        setStatus("Lỗi đọc PDF");
        log("Không đọc được PDF. Có thể file bị mã hoá hoặc hỏng.", "err");
        log(String(e), "err");
      }
    });

    btnInfo.addEventListener("click", async () => {
      if (!currentFile) return;
      clearLog();
      setStatus("Đang lấy thông tin...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("Xong");
        metaEl.textContent = `Số trang: ${currentPageCount}`;
        log(`PDF có ${currentPageCount} trang.`, "ok");
        log(`Ví dụ theo yêu cầu: 1-3|4-6|7,9|10`);
        log(`Ví dụ theo dung lượng: nhập 5 (MB) để chia mỗi file <= 5MB.`);
      } catch (e){
        setStatus("Lỗi");
        log(String(e), "err");
      }
    });

    async function buildPdfBytesFromPages(srcDoc, pages1Based){
      const newDoc = await PDFLib.PDFDocument.create();
      const idx0 = pages1Based.map(p => p-1);
      const copied = await newDoc.copyPages(srcDoc, idx0);
      copied.forEach(pg => newDoc.addPage(pg));
      const bytes = await newDoc.save();
      return bytes;
    }

    function pagesLabel(pages, width){
      if (!pages.length) return "p";
      const a = padNumber(pages[0], width);
      const b = padNumber(pages[pages.length-1], width);
      return (pages.length === 1) ? `p${a}` : `p${a}-${b}`;
    }

    btnSplit.addEventListener("click", async () => {
      if (!currentFile || !currentPdfBytes) return;

      clearLog();
      btnSplit.disabled = true;
      btnInfo.disabled = true;

      try{
        const mode = getMode();
        setStatus("Đang mở PDF...");
        const srcDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
        const pageCount = srcDoc.getPageCount();
        const width = String(pageCount).length;

        const baseFromFile = getBaseName(currentFile.name);
        const zip = new JSZip();

        const zipName = (zipNameInput.value || "").trim() || `${baseFromFile}_split.zip`;

        log(`Chế độ: ${mode}`, "ok");
        log(`Tổng trang: ${pageCount}`, "ok");

        // 1) Tạo danh sách nhóm trang theo mode
        let groups = [];

        if (mode === "single"){
          groups = Array.from({length: pageCount}, (_,i)=>[i+1]);
        }

        if (mode === "custom"){
          const spec = (customSpec.value || "").trim();
          groups = parseGroups(spec, pageCount);
          if (!groups.length){
            throw new Error("Chế độ 'theo yêu cầu' cần nhập nhóm trang. Ví dụ: 1-3|4-6|7,9|10");
          }
        }

        if (mode === "size"){
          const limitMB = Number(maxMB.value);
          if (!Number.isFinite(limitMB) || limitMB <= 0) {
            throw new Error("Dung lượng (MB) không hợp lệ.");
          }
          const maxBytes = Math.floor(limitMB * 1024 * 1024);

          // Build groups theo giới hạn dung lượng dựa trên size thật của PDF output
          let currentPages = [];
          let currentBytes = null;

          const finalizeCurrent = () => {
            if (currentPages.length && currentBytes) {
              groups.push({ pages: currentPages.slice(), bytes: currentBytes });
            }
          };

          setStatus("Đang chia nhóm theo dung lượng...");
          for (let p = 1; p <= pageCount; p++){
            const candidatePages = currentPages.concat([p]);
            const candidateBytes = await buildPdfBytesFromPages(srcDoc, candidatePages);

            // chấp nhận nếu <= limit hoặc nhóm đang rỗng (trang đơn lẻ có thể vượt)
            if (candidateBytes.length <= maxBytes || currentPages.length === 0){
              currentPages = candidatePages;
              currentBytes = candidateBytes;

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);

              if (candidateBytes.length > maxBytes && currentPages.length === 1){
                log(`Trang ${p} riêng lẻ đã ${(candidateBytes.length/1024/1024).toFixed(2)} MB > ${limitMB} MB (bắt buộc).`, "err");
              }
            } else {
              // chốt file trước đó
              finalizeCurrent();
              // bắt đầu nhóm mới với trang p
              currentPages = [p];
              currentBytes = await buildPdfBytesFromPages(srcDoc, currentPages);

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);
            }
          }
          finalizeCurrent();

          // nhóm ở mode size đã có bytes sẵn => convert sang format chung phía dưới
          log(`Đã chia thành ${groups.length} file theo dung lượng ~≤ ${limitMB} MB.`, "ok");
        }

        // 2) Xuất file vào ZIP
        setStatus("Đang tạo file & đưa vào ZIP...");

        let outCount = 0;

        if (mode === "size"){
          // groups là [{pages,bytes}]
          const prefix = (sizePrefix.value || "").trim() || baseFromFile;
          for (let i = 0; i < groups.length; i++){
            const pages = groups[i].pages;
            const bytes = groups[i].bytes;
            const label = pagesLabel(pages, width);
            const fname = `${prefix}_${padNumber(i+1, 2)}_${label}.pdf`;

            zip.file(fname, bytes);
            outCount++;

            const pct = 55 + Math.round(((i+1)/groups.length) * 30);
            setBar(pct);

            log(`+ ${fname} (${(bytes.length/1024/1024).toFixed(2)} MB)`);
          }
        } else {
          // single/custom: groups là [[...], [...]]
          const prefix = (mode === "custom")
            ? ((customPrefix.value || "").trim() || baseFromFile)
            : baseFromFile;

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i];
            const bytes = await buildPdfBytesFromPages(srcDoc, pages);

            let fname;
            if (mode === "single"){
              fname = `${prefix}_${pagesLabel(pages, width)}.pdf`;
            } else {
              // custom
              fname = `${prefix}_${padNumber(i+1, 2)}_${pagesLabel(pages, width)}.pdf`;
            }

            zip.file(fname, bytes);
            outCount++;

            const pct = 55 + Math.round(((i+1)/groups.length) * 30);
            setBar(pct);

            if ((i+1) % 3 === 0 || i === groups.length - 1) log(`Đã tạo ${i+1}/${groups.length} file...`);
          }
        }

        // 3) Nén ZIP và tải xuống
        setStatus("Đang nén ZIP...");
        setBar(90);

        const zipBlob = await zip.generateAsync({ type: "blob" }, (meta) => {
          const pct = 90 + Math.round((meta.percent/100)*10);
          setBar(pct);
        });

        downloadBlob(zipBlob, zipName);
        setStatus("Hoàn tất ✅");
        setBar(100);
        log(`Đã tạo ${outCount} file PDF và nén vào: ${zipName}`, "ok");

      } catch (e){
        setStatus("Có lỗi ❌");
        log("Lỗi:", "err");
        log(String(e), "err");
      } finally {
        btnSplit.disabled = false;
        btnInfo.disabled = false;
      }
    });
  </script>
</body>
</html>
