<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Tool Kit - T√°ch | G·ªôp | N√©n</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #2563eb;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --border: #e2e8f0;
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); }
    .container { max-width: 900px; margin: 0 auto; }
    
    .header { text-align: center; margin-bottom: 20px; }
    .nav-main { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;}
    .nav-btn { border: none; background: #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; color: #64748b; transition:.2s; }
    .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

    .card { background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 15px; padding: 20px; }
    .step-badge { background: #3b82f6; color: white; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 5px; }
    .card h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center;}

    /* Drop Zone */
    .drop-zone { border: 2px dashed #cbd5e1; border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; background: #f8fafc; transition: .2s; display: block; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #eff6ff; transform: scale(1.01); }
    
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
    input[type="text"], input[type="number"], textarea, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; font-size: 14px; }
    
    .btn-action { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: .2s; }
    .btn-action:hover { background: #1d4ed8; }
    .btn-action:disabled { background: #94a3b8; cursor: not-allowed; }

    /* Tabs Split */
    .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
    .tab-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 500; color: #64748b; }
    .tab-item.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .hidden { display: none !important; }
    
    .log-area { background: #1e293b; color: #fff; padding: 10px; border-radius: 8px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
    .file-tag { display: inline-block; background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin: 2px; font-weight: 500; border: 1px solid #cbd5e1; }
    
    .warning-box { background: #fff7ed; border: 1px solid #fdba74; color: #c2410c; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>üõ†Ô∏è PDF Tool Kit V4</h2>
  </div>

  <div class="nav-main">
    <button class="nav-btn active" onclick="setApp('split')">‚úÇÔ∏è T√°ch File</button>
    <button class="nav-btn" onclick="setApp('merge')">üîó G·ªôp File</button>
    <button class="nav-btn" onclick="setApp('compress')">üóúÔ∏è N√©n (Gi·∫£m MB)</button>
  </div>

  <div id="app-split">
    <div class="card">
      <h3><span class="step-badge">1</span> Ch·ªçn File PDF G·ªëc</h3>
      <label class="drop-zone" id="dropSplit">
        <input type="file" id="fileSplit" accept="application/pdf" hidden>
        <div style="font-size: 28px;">üìÇ</div>
        <div>Click ho·∫∑c K√©o file v√†o ƒë√¢y</div>
        <div id="splitInfo" style="color:var(--primary); font-weight:bold; margin-top:5px"></div>
      </label>
    </div>
    <div class="card">
      <h3><span class="step-badge">2</span> C·∫•u h√¨nh</h3>
      <div class="tabs">
        <div class="tab-item active" onclick="setSplitMode('single', this)">T√°ch l·∫ª</div>
        <div class="tab-item" onclick="setSplitMode('custom', this)">T√°ch nh√≥m</div>
        <div class="tab-item" onclick="setSplitMode('size', this)">Theo MB</div>
      </div>
      <div id="mode-single">
        <label>Danh s√°ch t√™n file (Tu·ª≥ ch·ªçn):</label>
        <textarea id="splitNames" placeholder="D√°n danh s√°ch t√™n..."></textarea>
      </div>
      <div id="mode-custom" class="hidden">
        <label>C√¥ng th·ª©c (VD: 1-5 | 8 | 10-12):</label>
        <input type="text" id="customRange">
        <label style="margin-top:10px">T√™n t·ª´ng nh√≥m:</label>
        <textarea id="customNames"></textarea>
      </div>
      <div id="mode-size" class="hidden">
        <label>Gi·ªõi h·∫°n (MB):</label>
        <input type="number" id="splitMaxMB" value="5">
      </div>
    </div>
    <button id="btnSplit" class="btn-action" disabled>üöÄ T√°ch Ngay</button>
  </div>

  <div id="app-merge" class="hidden">
    <div class="card">
      <h3><span class="step-badge">1</span> Ch·ªçn File G·ªôp</h3>
      <label class="drop-zone" id="dropMerge">
        <input type="file" id="fileMerge" accept="application/pdf" multiple hidden>
        <div style="font-size: 28px;">üìö</div>
        <div>Ch·ªçn ho·∫∑c K√©o nhi·ªÅu file</div>
      </label>
      <div id="mergeList" style="margin-top:10px"></div>
    </div>
    <div class="card">
      <h3><span class="step-badge">2</span> L∆∞u</h3>
      <label>T√™n file ra:</label>
      <input type="text" id="mergeName" value="Gop_File.pdf">
    </div>
    <button id="btnMerge" class="btn-action" disabled>üîó G·ªôp Ngay</button>
  </div>

  <div id="app-compress" class="hidden">
    <div class="card">
      <h3><span class="step-badge">1</span> Ch·ªçn File C·∫ßn N√©n</h3>
      <label class="drop-zone" id="dropCompress">
        <input type="file" id="fileCompress" accept="application/pdf" hidden>
        <div style="font-size: 28px;">üóúÔ∏è</div>
        <div>Ch·ªçn file PDF dung l∆∞·ª£ng l·ªõn</div>
        <div id="compressInfo" style="color:var(--primary); font-weight:bold; margin-top:5px"></div>
      </label>
    </div>
    
    <div class="card">
      <h3><span class="step-badge">2</span> M·ª©c ƒë·ªô n√©n</h3>
      <div class="warning-box">
        ‚ö†Ô∏è <b>L∆∞u √Ω:</b> Ch·∫ø ƒë·ªô n√†y s·∫Ω chuy·ªÉn trang PDF th√†nh ·∫£nh r·ªìi n√©n l·∫°i. <br>
        File s·∫Ω nh·∫π h∆°n nhi·ªÅu nh∆∞ng <b>kh√¥ng th·ªÉ b√¥i ƒëen/copy ch·ªØ</b> ƒë∆∞·ª£c n·ªØa.
      </div>
      <label>Ch·∫•t l∆∞·ª£ng ·∫£nh ƒë·∫ßu ra:</label>
      <select id="compressQuality">
        <option value="0.4">N√©n M·∫°nh (File r·∫•t nh·∫π, ·∫£nh m·ªù)</option>
        <option value="0.6" selected>N√©n V·ª´a (Khuy√™n d√πng)</option>
        <option value="0.8">N√©n √çt (Gi·ªØ n√©t, gi·∫£m √≠t)</option>
      </select>
    </div>
    <button id="btnCompress" class="btn-action" disabled>üìâ B·∫Øt ƒë·∫ßu N√©n</button>
  </div>

  <div class="log-area" id="logBox">S·∫µn s√†ng...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

<script>
  // C·∫•u h√¨nh Worker cho PDF.js
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

  // Ch·∫∑n m·ªü file
  window.addEventListener("dragover", e => e.preventDefault());
  window.addEventListener("drop", e => e.preventDefault());

  const $ = (id) => document.getElementById(id);
  const logBox = $('logBox');
  function log(m) { logBox.innerHTML += `<div>> ${m}</div>`; logBox.scrollTop = logBox.scrollHeight; }

  // --- STATE ---
  let splitBytes=null, splitName='', splitMode='single';
  let mergeFiles=[], compressBytes=null, compressName='';

  // --- NAV ---
  function setApp(app) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    ['split','merge','compress'].forEach(k => $(`app-${k}`).classList.add('hidden'));
    $(`app-${app}`).classList.remove('hidden');
  }

  // --- DROP HELPER ---
  function setupDrop(id, cb) {
    const el = $(id);
    el.addEventListener('dragenter', ()=>el.classList.add('dragover'));
    el.addEventListener('dragleave', ()=>el.classList.remove('dragover'));
    el.addEventListener('drop', (e)=>{
      el.classList.remove('dragover');
      if(e.dataTransfer.files.length) cb(e.dataTransfer.files);
    });
    el.querySelector('input').addEventListener('change', function(){
      if(this.files.length) cb(this.files);
    });
  }

  // ================= T√ÅCH =================
  setupDrop('dropSplit', async (files)=>{
    const f = files[0];
    if(f.type!=='application/pdf') return alert('Ph·∫£i l√† PDF');
    splitBytes = await f.arrayBuffer();
    splitName = f.name.replace('.pdf','');
    $('splitInfo').textContent = `${f.name} (${(f.size/1e6).toFixed(2)} MB)`;
    $('btnSplit').disabled=false;
    log(`ƒê√£ n·∫°p file t√°ch: ${f.name}`);
  });

  window.setSplitMode = (m, el) => {
    splitMode = m;
    document.querySelectorAll('.tab-item').forEach(i=>i.classList.remove('active'));
    el.classList.add('active');
    ['single','custom','size'].forEach(x=>$(`mode-${x}`).classList.add('hidden'));
    $(`mode-${m}`).classList.remove('hidden');
  }

  $('btnSplit').addEventListener('click', async ()=>{
    if(!splitBytes) return;
    $('btnSplit').disabled=true; log('ƒêang t√°ch...');
    try {
      const pdfDoc = await PDFLib.PDFDocument.load(splitBytes);
      const total = pdfDoc.getPageCount();
      const zip = new JSZip();
      let groups = [];
      
      // Logic ph√¢n nh√≥m
      if(splitMode==='single') {
        for(let i=0; i<total; i++) groups.push([i]);
      } else if(splitMode==='custom') {
        const parts = $('customRange').value.split('|');
        parts.forEach(p => {
          let g = [];
          p.split(',').forEach(s => {
            if(s.includes('-')) {
              let [a,b] = s.split('-').map(Number);
              for(let k=a; k<=b; k++) if(k<=total) g.push(k-1);
            } else {
              let n=Number(s); if(n<=total) g.push(n-1);
            }
          });
          if(g.length) groups.push(g);
        });
      } else {
        const max = $('splitMaxMB').value * 1024 * 1024;
        let curG=[], curS=0;
        for(let i=0; i<total; i++) {
          const t = await PDFLib.PDFDocument.create();
          const [cp] = await t.copyPages(pdfDoc,[i]);
          t.addPage(cp);
          const b = await t.save();
          if(curG.length && (curS+b.length > max)) { groups.push(curG); curG=[]; curS=0; }
          curG.push(i); curS+=b.length;
        }
        if(curG.length) groups.push(curG);
      }

      // T·∫°o file
      const names = (splitMode==='single' ? $('splitNames').value : $('customNames').value).split('\n');
      for(let i=0; i<groups.length; i++){
        const newPdf = await PDFLib.PDFDocument.create();
        const cp = await newPdf.copyPages(pdfDoc, groups[i]);
        cp.forEach(p=>newPdf.addPage(p));
        const b = await newPdf.save();
        let fn = names[i]?.trim() || `${splitName}_Part_${i+1}`;
        zip.file(`${fn}.pdf`, b);
      }
      const z = await zip.generateAsync({type:'blob'});
      save(z, 'Split_Result.zip');
      log('‚úÖ T√°ch xong!');
    } catch(e) { log('‚ùå L·ªói: '+e.message); }
    $('btnSplit').disabled=false;
  });

  // ================= G·ªòP =================
  setupDrop('dropMerge', async (files)=>{
    for(let f of files) {
      if(f.type==='application/pdf') mergeFiles.push({name:f.name, data:await f.arrayBuffer()});
    }
    renderMerge();
  });
  function renderMerge(){
    $('mergeList').innerHTML = mergeFiles.map((f,i)=>`<span class="file-tag">${i+1}. ${f.name} <b style="color:red;cursor:pointer" onclick="delMerge(${i})">x</b></span>`).join('');
    $('btnMerge').disabled = mergeFiles.length<2;
  }
  window.delMerge = (i) => { mergeFiles.splice(i,1); renderMerge(); }

  $('btnMerge').addEventListener('click', async ()=>{
    $('btnMerge').disabled=true; log('ƒêang g·ªôp...');
    try {
      const doc = await PDFLib.PDFDocument.create();
      for(let f of mergeFiles){
        const s = await PDFLib.PDFDocument.load(f.data);
        const cp = await doc.copyPages(s, s.getPageIndices());
        cp.forEach(p=>doc.addPage(p));
      }
      save(new Blob([await doc.save()],{type:'application/pdf'}), $('mergeName').value);
      log('‚úÖ G·ªôp xong!');
    } catch(e){ log('‚ùå L·ªói: '+e.message); }
    $('btnMerge').disabled=false;
  });

  // ================= N√âN (COMPRESS) =================
  setupDrop('dropCompress', async (files)=>{
    const f = files[0];
    if(f.type!=='application/pdf') return alert('Ph·∫£i l√† PDF');
    compressBytes = await f.arrayBuffer();
    compressName = f.name;
    $('compressInfo').textContent = `${f.name} (${(f.size/1e6).toFixed(2)} MB)`;
    $('btnCompress').disabled=false;
    log(`ƒê√£ n·∫°p file n√©n: ${f.name}`);
  });

  $('btnCompress').addEventListener('click', async ()=>{
    if(!compressBytes) return;
    const btn = $('btnCompress');
    btn.disabled=true; 
    log('‚è≥ ƒêang n√©n (Qu√° tr√¨nh n√†y h∆°i l√¢u, vui l√≤ng ch·ªù)...');
    
    try {
      const quality = parseFloat($('compressQuality').value);
      
      // 1. Load PDF g·ªëc b·∫±ng PDF.js ƒë·ªÉ render ra ·∫£nh
      const loadingTask = pdfjsLib.getDocument(compressBytes);
      const pdf = await loadingTask.promise;
      const total = pdf.numPages;
      
      // 2. T·∫°o PDF m·ªõi
      const newPdf = await PDFLib.PDFDocument.create();

      for (let i = 1; i <= total; i++) {
        log(`ƒêang x·ª≠ l√Ω trang ${i}/${total}...`);
        
        const page = await pdf.getPage(i);
        // Scale 1.5 ƒë·ªÉ gi·ªØ n√©t ch·ªØ t∆∞∆°ng ƒë·ªëi, sau ƒë√≥ n√©n JPEG
        const viewport = page.getViewport({ scale: 1.5 });
        
        // T·∫°o canvas ·∫£o
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        // Convert canvas sang JPEG n√©n
        const imgDataUrl = canvas.toDataURL('image/jpeg', quality);
        const imgBytes = await fetch(imgDataUrl).then(res => res.arrayBuffer());

        // Nh√∫ng ·∫£nh v√†o PDF m·ªõi
        const embeddedImg = await newPdf.embedJpg(imgBytes);
        const newPage = newPdf.addPage([viewport.width, viewport.height]);
        newPage.drawImage(embeddedImg, {
          x: 0, y: 0, width: viewport.width, height: viewport.height,
        });
      }

      const resultBytes = await newPdf.save();
      const blob = new Blob([resultBytes], {type: 'application/pdf'});
      
      log(`‚úÖ N√©n xong! T·∫£i xu·ªëng...`);
      save(blob, `Compressed_${compressName}`);

    } catch (e) {
      log('‚ùå L·ªói n√©n: ' + e.message);
      console.error(e);
    }
    btn.disabled = false;
  });

  function save(blob, name) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
  }
</script>
</body>
</html>
