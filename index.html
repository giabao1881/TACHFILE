<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C√¥ng c·ª• T√°ch PDF & ƒê·∫∑t t√™n t·ª± ƒë·ªông</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #2563eb;       /* Xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
      --primary-hover: #1d4ed8;
      --bg-body: #f1f5f9;       /* X√°m nh·∫°t n·ªÅn */
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 20px;
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      line-height: 1.5;
    }

    .container { max-width: 900px; margin: 0 auto; }
    
    /* Header */
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { margin: 0; font-size: 24px; font-weight: 700; color: #0f172a; }
    .header p { margin: 5px 0 0; color: var(--text-sub); font-size: 14px; }

    /* Card Layout */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .card-header {
      padding: 15px 20px;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 16px;
      display: flex; align-items: center; gap: 10px;
    }
    .step-num {
      background: var(--primary); color: white;
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px;
    }

    .card-body { padding: 20px; }

    /* INPUT FILE AREA */
    .drop-zone {
      border: 2px dashed #cbd5e1;
      border-radius: var(--radius);
      padding: 30px;
      text-align: center;
      transition: .2s;
      cursor: pointer;
      background: #f8fafc;
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--primary);
      background: #eff6ff;
    }
    .drop-zone input { display: none; }
    .file-info { margin-top: 10px; font-weight: 500; color: var(--primary); }

    /* TABS MODE */
    .tabs { display: flex; gap: 5px; background: #f1f5f9; padding: 5px; border-radius: 10px; margin-bottom: 20px; }
    .tab-btn {
      flex: 1; border: none; background: transparent;
      padding: 10px; border-radius: 8px;
      font-weight: 500; color: var(--text-sub); cursor: pointer;
      transition: .2s; font-size: 14px;
    }
    .tab-btn.active {
      background: white; color: var(--primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 600;
    }

    /* FORM ELEMENTS */
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; color: #334155; }
    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 10px 12px;
      border: 1px solid #cbd5e1; border-radius: 8px;
      font-family: inherit; font-size: 14px;
      transition: .2s; outline: none;
    }
    input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    textarea { min-height: 120px; resize: vertical; }
    .hint { font-size: 12px; color: var(--text-sub); margin-top: 5px; }
    
    .hidden { display: none; }

    /* BUTTONS */
    .btn-action {
      width: 100%;
      background: var(--primary); color: white;
      border: none; padding: 14px;
      border-radius: var(--radius);
      font-size: 16px; font-weight: 600;
      cursor: pointer; transition: .2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-action:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-action:disabled { opacity: 0.6; cursor: not-allowed; transform: none; background: #94a3b8; }

    /* LOGS & PROGRESS */
    .progress-wrap { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 15px; }
    .progress-bar { height: 100%; width: 0%; background: #10b981; transition: width 0.2s; }
    
    .log-box {
      background: #1e293b; color: #e2e8f0;
      padding: 15px; border-radius: 8px;
      font-family: monospace; font-size: 13px;
      height: 200px; overflow-y: auto;
      margin-top: 15px; white-space: pre-wrap;
    }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-info { color: #60a5fa; }

    /* Custom highlight for naming feature */
    .feature-highlight {
      border: 1px solid #bfdbfe; background: #eff6ff;
      padding: 12px; border-radius: 8px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Tool T√°ch PDF & ƒê·∫∑t T√™n by baotg10</h1>
    <p>X·ª≠ l√Ω ngay tr√™n tr√¨nh duy·ªát - B·∫£o m·∫≠t - Nhanh ch√≥ng</p>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="step-num">1</div>
      <span>Ch·ªçn file PDF</span>
    </div>
    <div class="card-body">
      <label class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="application/pdf">
        <span style="font-size: 24px; display:block; margin-bottom:8px">üìÇ</span>
        <span>B·∫•m ƒë·ªÉ ch·ªçn file ho·∫∑c K√©o th·∫£ v√†o ƒë√¢y</span>
        <div id="fileDisplay" class="file-info hidden"></div>
      </label>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="step-num">2</div>
      <span>C·∫•u h√¨nh t√°ch</span>
    </div>
    <div class="card-body">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchMode('single')">T√°ch l·∫ª t·ª´ng trang</button>
        <button class="tab-btn" onclick="switchMode('custom')">T√°ch theo nh√≥m</button>
        <button class="tab-btn" onclick="switchMode('size')">T√°ch theo dung l∆∞·ª£ng</button>
      </div>

      <div id="mode-single" class="mode-content">
        <div class="feature-highlight">
          <label>üìù ƒê·∫∑t t√™n file theo danh s√°ch (Tu·ª≥ ch·ªçn)</label>
          <div class="hint" style="margin-bottom:8px">
            D√°n danh s√°ch t√™n v√†o d∆∞·ªõi (Excel/Word). <b>D√≤ng 1 s·∫Ω ƒë·∫∑t cho Trang 1, D√≤ng 2 cho Trang 2...</b> theo ƒë√∫ng th·ª© t·ª±.
          </div>
          <textarea id="singleNames" placeholder="V√≠ d·ª•:
HO_SO_NGUYEN_VAN_A
HO_SO_NGUYEN_VAN_B
..."></textarea>
        </div>
        <div class="hint">N·∫øu ƒë·ªÉ tr·ªëng, tool s·∫Ω t·ª± ƒë·∫∑t t√™n d·∫°ng: <i>TenGoc_p01.pdf</i></div>
      </div>

      <div id="mode-custom" class="mode-content hidden">
        <div class="form-group">
          <label>Nh·∫≠p nh√≥m trang c·∫ßn t√°ch</label>
          <input type="text" id="customSpec" placeholder="V√≠ d·ª•: 1-3|4-6|7,9|10">
          <div class="hint">D√πng d·∫•u <b>|</b> ƒë·ªÉ ngƒÉn c√°ch c√°c file. D√πng <b>-</b> cho kho·∫£ng trang.</div>
        </div>
        <div class="form-group">
          <label>Danh s√°ch t√™n cho t·ª´ng nh√≥m (Tu·ª≥ ch·ªçn)</label>
          <textarea id="customNames" placeholder="M·ªói d√≤ng t∆∞∆°ng ·ª©ng v·ªõi 1 nh√≥m b√™n tr√™n"></textarea>
        </div>
        <div class="form-group">
          <label>Ti·ªÅn t·ªë t√™n file (N·∫øu kh√¥ng nh·∫≠p t√™n c·ª• th·ªÉ)</label>
          <input type="text" id="customPrefix" placeholder="V√≠ d·ª•: HO_SO_KHACH_HANG">
        </div>
      </div>

      <div id="mode-size" class="mode-content hidden">
        <div class="form-group">
          <label>Gi·ªõi h·∫°n dung l∆∞·ª£ng m·ªói file (MB)</label>
          <input type="number" id="maxMB" value="5" min="0.5" step="0.5">
          <div class="hint">Tool s·∫Ω g·ªôp c√°c trang sao cho kh√¥ng v∆∞·ª£t qu√° s·ªë n√†y.</div>
        </div>
        <div class="form-group">
          <label>Ti·ªÅn t·ªë t√™n file</label>
          <input type="text" id="sizePrefix" placeholder="V√≠ d·ª•: PART">
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="step-num">3</div>
      <span>Xu·∫•t file</span>
    </div>
    <div class="card-body">
      <div class="form-group">
        <label>T√™n file ZIP k·∫øt qu·∫£</label>
        <input type="text" id="zipName" placeholder="M·∫∑c ƒë·ªãnh: TenFile_split.zip">
      </div>
      
      <button id="btnSplit" class="btn-action" disabled>
        üöÄ T√°ch & T·∫£i ZIP ngay
      </button>

      <div class="progress-wrap">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      
      <div class="log-box" id="logBox">Tr·∫°ng th√°i: ƒêang ch·ªù ch·ªçn file...</div>
    </div>
  </div>
  
  <div style="text-align:center; color:#94a3b8; font-size:13px; margin-top:20px">
    ¬© 2024 baotg10, kh√¥ng upload file l√™n server.
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
  // === DOM ELEMENTS ===
  const $ = (id) => document.getElementById(id);
  const fileInput = $('fileInput');
  const fileDisplay = $('fileDisplay');
  const btnSplit = $('btnSplit');
  const logBox = $('logBox');
  const progressBar = $('progressBar');
  
  let currentFile = null;
  let currentPdfBytes = null;
  let currentMode = 'single';
  let pdfDoc = null;

  // === UI HANDLERS ===
  function switchMode(mode) {
    currentMode = mode;
    // Update Tabs
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    // Update Content
    document.querySelectorAll('.mode-content').forEach(d => d.classList.add('hidden'));
    $(`mode-${mode}`).classList.remove('hidden');
    
    log(`ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô: ${getModeName(mode)}`, 'info');
  }

  function getModeName(m) {
    if(m==='single') return 'T√°ch l·∫ª t·ª´ng trang';
    if(m==='custom') return 'T√°ch theo nh√≥m';
    return 'T√°ch theo dung l∆∞·ª£ng';
  }

  // File Selection
  fileInput.addEventListener('change', async () => {
    const f = fileInput.files[0];
    if (!f) return;
    handleFile(f);
  });

  async function handleFile(f) {
    currentFile = f;
    btnSplit.disabled = true;
    fileDisplay.textContent = `üìÑ ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
    fileDisplay.classList.remove('hidden');
    
    log(`ƒêang ƒë·ªçc file: ${f.name}...`, 'info');
    
    try {
      const buf = await f.arrayBuffer();
      currentPdfBytes = new Uint8Array(buf);
      pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes);
      const pages = pdfDoc.getPageCount();
      
      log(`‚úÖ ƒê√£ t·∫£i xong. T·ªïng s·ªë trang: ${pages}`, 'success');
      log(`üëâ H√£y ch·ªçn ch·∫ø ƒë·ªô t√°ch ·ªü b∆∞·ªõc 2 r·ªìi b·∫•m n√∫t T√°ch.`, 'info');
      btnSplit.disabled = false;
    } catch (e) {
      log(`‚ùå L·ªói ƒë·ªçc file: ${e.message}`, 'error');
    }
  }

  // Logging
  function log(msg, type='normal') {
    const div = document.createElement('div');
    div.textContent = `> ${msg}`;
    if(type==='success') div.classList.add('log-success');
    if(type==='error') div.classList.add('log-error');
    if(type==='info') div.classList.add('log-info');
    logBox.appendChild(div);
    logBox.scrollTop = logBox.scrollHeight;
  }
  
  function setProgress(percent) {
    progressBar.style.width = `${percent}%`;
  }

  // === LOGIC CORE ===
  
  // Helpers
  const readLines = (txt) => txt.split('\n').map(x => x.trim());
  const sanitize = (name) => name.replace(/[\/\\:\*\?"<>\|]/g, "_").trim();
  const pad = (n) => String(n).padStart(2, '0');
  
  function parsePageRanges(text, maxPage) {
    // Logic x·ª≠ l√Ω 1-3|5|...
    if(!text.trim()) return [];
    const groups = [];
    const parts = text.split('|');
    for(let p of parts) {
      const subParts = p.split(',');
      const pageSet = new Set();
      for(let sp of subParts) {
        const m = sp.trim().match(/^(\d+)\s*-\s*(\d+)$/);
        if(m) {
          let a = parseInt(m[1]), b = parseInt(m[2]);
          if(a>b) [a,b] = [b,a];
          for(let i=a; i<=b; i++) if(i>=1 && i<=maxPage) pageSet.add(i);
        } else {
          let n = parseInt(sp);
          if(n>=1 && n<=maxPage) pageSet.add(n);
        }
      }
      if(pageSet.size > 0) groups.push(Array.from(pageSet).sort((a,b)=>a-b));
    }
    return groups;
  }

  // MAIN SPLIT FUNCTION
  btnSplit.addEventListener('click', async () => {
    if(!currentPdfBytes || !pdfDoc) return;
    
    btnSplit.disabled = true;
    logBox.textContent = ''; // Clear log
    log('B·∫Øt ƒë·∫ßu x·ª≠ l√Ω...', 'info');
    setProgress(10);

    try {
      const pageCount = pdfDoc.getPageCount();
      const zip = new JSZip();
      const baseName = currentFile.name.replace(/\.pdf$/i, '');
      const zipName = ($('zipName').value.trim() || `${baseName}_split`) + '.zip';
      
      let groups = [];
      let nameList = [];
      let prefix = baseName;
      let isSingleMode = false;

      // 1. X√°c ƒë·ªãnh Groups d·ª±a tr√™n Mode
      if (currentMode === 'single') {
        isSingleMode = true;
        // M·ªói trang l√† 1 group
        for(let i=1; i<=pageCount; i++) groups.push([i]);
        
        // L·∫•y list t√™n
        const rawNames = $('singleNames').value;
        if(rawNames.trim()) {
          nameList = readLines(rawNames);
          log(`ƒê√£ nh·∫≠n di·ªán danh s√°ch t√™n tu·ª≥ ch·ªânh (${nameList.length} d√≤ng).`, 'info');
        }
        
      } else if (currentMode === 'custom') {
        const spec = $('customSpec').value;
        groups = parsePageRanges(spec, pageCount);
        if(!groups.length) throw new Error("Ch∆∞a nh·∫≠p nh√≥m trang h·ª£p l·ªá (v√≠ d·ª•: 1-3|4-6)");
        
        const rawNames = $('customNames').value;
        if(rawNames.trim()) nameList = readLines(rawNames);
        
        if($('customPrefix').value.trim()) prefix = $('customPrefix').value.trim();

      } else if (currentMode === 'size') {
        // Logic t√°ch theo dung l∆∞·ª£ng
        log('ƒêang t√≠nh to√°n dung l∆∞·ª£ng c√°c trang...', 'info');
        const maxMB = parseFloat($('maxMB').value);
        const maxBytes = maxMB * 1024 * 1024;
        
        let currentGroup = [];
        let currentGroupBytes = 0;
        
        // Helper copy trang ƒë·ªÉ ƒëo dung l∆∞·ª£ng
        const tempDoc = await PDFLib.PDFDocument.create();
        
        for(let i=0; i<pageCount; i++) { // 0-based index for copy
          const subDoc = await PDFLib.PDFDocument.create();
          const [copiedPage] = await subDoc.copyPages(pdfDoc, [i]);
          subDoc.addPage(copiedPage);
          const bytes = await subDoc.save();
          
          if (currentGroup.length > 0 && (currentGroupBytes + bytes.length) > maxBytes) {
             groups.push(currentGroup);
             currentGroup = [];
             currentGroupBytes = 0;
          }
          currentGroup.push(i+1); // Store as 1-based
          currentGroupBytes += bytes.length;
          
          setProgress(10 + Math.floor((i/pageCount)*20));
        }
        if(currentGroup.length) groups.push(currentGroup);
        
        if($('sizePrefix').value.trim()) prefix = $('sizePrefix').value.trim();
        log(`ƒê√£ chia th√†nh ${groups.length} file theo gi·ªõi h·∫°n ${maxMB}MB`, 'success');
      }

      // 2. T·∫°o PDF con v√† th√™m v√†o ZIP
      log(`B·∫Øt ƒë·∫ßu t·∫°o ${groups.length} file PDF...`, 'info');
      
      const usedNames = {}; // Tr√°nh tr√πng t√™n
      
      for(let i=0; i<groups.length; i++) {
        const pages = groups[i]; // m·∫£ng c√°c trang (1-based)
        
        // T·∫°o file PDF m·ªõi
        const newPdf = await PDFLib.PDFDocument.create();
        const pagesIndices = pages.map(p => p - 1); // convert to 0-based
        const copiedPages = await newPdf.copyPages(pdfDoc, pagesIndices);
        copiedPages.forEach(p => newPdf.addPage(p));
        const pdfBytes = await newPdf.save();
        
        // ƒê·∫∑t t√™n file
        let fileName = "";
        
        if (isSingleMode && nameList.length > 0) {
          // Logic quan tr·ªçng: Trang th·ª© N d√πng t√™n d√≤ng th·ª© N
          // pageNo l√† pages[0]
          const pageIndex = i; // V√¨ groups[i] t∆∞∆°ng ·ª©ng trang i+1 trong Single Mode
          if (nameList[pageIndex]) {
             fileName = sanitize(nameList[pageIndex]);
          }
        } else if (currentMode === 'custom' && nameList.length > 0) {
           if(nameList[i]) fileName = sanitize(nameList[i]);
        }
        
        // Fallback name n·∫øu kh√¥ng c√≥ t√™n custom ho·∫∑c t√™n r·ªóng
        if (!fileName) {
          const pageLabel = pages.length === 1 ? `p${pad(pages[0])}` : `p${pad(pages[0])}-${pad(pages[pages.length-1])}`;
          // N·∫øu mode size ho·∫∑c custom ko t√™n th√¨ d√πng s·ªë th·ª© t·ª±
          if(currentMode !== 'single') {
             fileName = `${prefix}_${pad(i+1)}_${pageLabel}`;
          } else {
             fileName = `${prefix}_${pageLabel}`;
          }
        }
        
        // X·ª≠ l√Ω tr√πng t√™n (th√™m s·ªë ƒë·∫øm)
        let finalName = fileName;
        let counter = 1;
        while(usedNames[finalName.toLowerCase()]) {
          finalName = `${fileName}_(${counter++})`;
        }
        usedNames[finalName.toLowerCase()] = true;
        
        zip.file(`${finalName}.pdf`, pdfBytes);
        
        // Update Log & Progress
        const pct = 30 + Math.floor(((i+1)/groups.length) * 60);
        setProgress(pct);
        if((i+1)%5 === 0 || i === groups.length-1) {
            log(`+ ƒê√£ t·∫°o: ${finalName}.pdf`);
        }
      }

      // 3. T·∫£i xu·ªëng
      log('ƒêang n√©n file ZIP...', 'info');
      const content = await zip.generateAsync({type:"blob"});
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(content);
      link.download = zipName;
      link.click();
      
      setProgress(100);
      log(`üéâ HO√ÄN T·∫§T! ƒê√£ t·∫£i xu·ªëng ${zipName}`, 'success');

    } catch (e) {
      console.error(e);
      log(`‚ùå C√ì L·ªñI: ${e.message}`, 'error');
    } finally {
      btnSplit.disabled = false;
    }
  });

</script>
</body>
</html>
