<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Tool Kit - T√°ch & G·ªôp V3</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #2563eb;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --border: #e2e8f0;
      --radius: 12px;
    }

    * { box-sizing: border-box; }
    body { margin: 0; padding: 20px; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); }
    .container { max-width: 900px; margin: 0 auto; }
    
    /* UI Components */
    .header { text-align: center; margin-bottom: 20px; }
    .nav-main { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    .nav-btn { border: none; background: #e2e8f0; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; color: #64748b; }
    .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

    .card { background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--border); margin-bottom: 15px; padding: 20px; }
    .card h3 { margin-top: 0; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;}
    .step-badge { background: #3b82f6; color: white; width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 5px; }

    /* Drop Zone */
    .drop-zone { border: 2px dashed #cbd5e1; border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; background: #f8fafc; transition: .2s; display: block; }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #eff6ff; transform: scale(1.01); }
    
    /* Inputs */
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 500; margin-bottom: 5px; font-size: 14px; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: inherit; font-size: 14px; }
    textarea { resize: vertical; min-height: 80px; }

    /* Guide Box - L√†m n·ªïi b·∫≠t h∆∞·ªõng d·∫´n */
    .guide-box { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; font-size: 13px; color: #0369a1; margin-top: 5px; line-height: 1.5; }
    .guide-box code { background: #fff; padding: 2px 5px; border-radius: 4px; font-weight: bold; border: 1px solid #bae6fd; font-family: monospace; color: #e11d48; }

    /* Buttons */
    .btn-action { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: .2s; }
    .btn-action:hover { background: #1d4ed8; }
    .btn-action:disabled { background: #94a3b8; cursor: not-allowed; }

    /* Tabs */
    .tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
    .tab-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 13px; font-weight: 500; color: #64748b; }
    .tab-item.active { background: white; color: var(--primary); font-weight: 700; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    .hidden { display: none; }
    
    /* Logs */
    .log-area { background: #1e293b; color: #fff; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
    .file-tag { display: inline-block; background: #e2e8f0; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin: 2px; font-weight: 500; border: 1px solid #cbd5e1; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>üõ†Ô∏è C√¥ng c·ª• X·ª≠ L√Ω PDF (V3)</h2>
  </div>

  <div class="nav-main">
    <button class="nav-btn active" onclick="setApp('split')">‚úÇÔ∏è T√°ch File</button>
    <button class="nav-btn" onclick="setApp('merge')">üîó G·ªôp File</button>
  </div>

  <div id="app-split">
    <div class="card">
      <h3><span class="step-badge">1</span> Ch·ªçn File PDF G·ªëc</h3>
      <label class="drop-zone" id="dropSplit">
        <input type="file" id="fileSplit" accept="application/pdf" hidden>
        <div style="font-size: 28px; margin-bottom: 5px;">üìÇ</div>
        <div><b>Click ƒë·ªÉ ch·ªçn file</b> ho·∫∑c K√©o file v√†o ƒë√¢y</div>
        <div id="splitFileInfo" style="margin-top:8px; color:#2563eb; font-weight:600"></div>
      </label>
    </div>

    <div class="card">
      <h3><span class="step-badge">2</span> Ch·ªçn C√°ch T√°ch</h3>
      <div class="tabs">
        <div class="tab-item active" onclick="setMode('single', this)">T√°ch t·ª´ng trang</div>
        <div class="tab-item" onclick="setMode('custom', this)">T√°ch theo nh√≥m</div>
        <div class="tab-item" onclick="setMode('size', this)">T√°ch theo dung l∆∞·ª£ng</div>
      </div>

      <div id="mode-single">
        <div class="guide-box">
          T√°ch m·ªói trang th√†nh 1 file ri√™ng bi·ªát.<br>
          V√≠ d·ª•: File g·ªëc c√≥ 10 trang => Ra 10 file nh·ªè.
        </div>
        <div style="margin-top:10px">
          <label>ƒê·∫∑t t√™n file (Tu·ª≥ ch·ªçn)</label>
          <textarea id="splitNames" placeholder="Copy danh s√°ch t√™n d√°n v√†o ƒë√¢y (M·ªói d√≤ng 1 t√™n). D√≤ng 1 ƒë·∫∑t cho trang 1, d√≤ng 2 cho trang 2..."></textarea>
        </div>
      </div>

      <div id="mode-custom" class="hidden">
        <div class="guide-box">
          D√πng d·∫•u g·∫°ch ƒë·ª©ng <code>|</code> ƒë·ªÉ ng·∫Øt file m·ªõi.<br>
          D√πng d·∫•u g·∫°ch ngang <code>-</code> ƒë·ªÉ l·∫•y nhi·ªÅu trang li·ªÅn nhau.<br><br>
          <b>V√≠ d·ª• d·ªÖ hi·ªÉu:</b> B·∫°n mu·ªën t√°ch l√†m 3 file:<br>
          - File 1: L·∫•y t·ª´ trang 1 ƒë·∫øn 5<br>
          - File 2: Ch·ªâ l·∫•y trang 8<br>
          - File 3: L·∫•y trang 10 ƒë·∫øn 12<br>
          => Nh·∫≠p v√†o √¥ d∆∞·ªõi: <code>1-5 | 8 | 10-12</code>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label>Nh·∫≠p c√¥ng th·ª©c t√°ch:</label>
          <input type="text" id="customRange" placeholder="VD: 1-5 | 8 | 10-12">
        </div>
        <div class="form-group">
          <label>T√™n cho t·ª´ng nh√≥m (M·ªói d√≤ng 1 t√™n)</label>
          <textarea id="customNames" placeholder="T√™n cho nh√≥m 1 (1-5)&#10;T√™n cho nh√≥m 2 (8)..."></textarea>
        </div>
      </div>

      <div id="mode-size" class="hidden">
        <div class="guide-box">
          Tool s·∫Ω c·ªông d·ªìn c√°c trang l·∫°i. Khi n√†o th·∫•y <b>g·∫ßn v∆∞·ª£t qu√°</b> dung l∆∞·ª£ng b·∫°n nh·∫≠p th√¨ n√≥ s·∫Ω c·∫Øt sang file m·ªõi.<br>
          <i>Th√≠ch h·ª£p ƒë·ªÉ chia nh·ªè file g·ª≠i Email/Zalo b·ªã gi·ªõi h·∫°n dung l∆∞·ª£ng.</i>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label>Dung l∆∞·ª£ng t·ªëi ƒëa m·ªói file (MB):</label>
          <input type="number" id="splitMaxMB" value="5" style="font-weight:bold; color:#2563eb">
        </div>
      </div>
    </div>

    <button id="btnDoSplit" class="btn-action" disabled>üöÄ T√°ch File Ngay</button>
  </div>

  <div id="app-merge" class="hidden">
    <div class="card">
      <h3><span class="step-badge">1</span> Ch·ªçn C√°c File C·∫ßn G·ªôp</h3>
      <label class="drop-zone" id="dropMerge">
        <input type="file" id="fileMerge" accept="application/pdf" multiple hidden>
        <div style="font-size: 28px; margin-bottom: 5px;">üìö</div>
        <div>Ch·ªçn nhi·ªÅu file ho·∫∑c K√©o nhi·ªÅu file v√†o ƒë√¢y</div>
      </label>
      <div id="mergeList" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h3><span class="step-badge">2</span> L∆∞u File</h3>
      <label>T√™n file k·∫øt qu·∫£:</label>
      <input type="text" id="mergeOutName" value="File_Da_Gop.pdf">
    </div>

    <button id="btnDoMerge" class="btn-action" disabled>üîó G·ªôp File Ngay</button>
  </div>

  <div class="log-area" id="logBox">Tr·∫°ng th√°i: S·∫µn s√†ng...</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
  // === CH·∫∂N TR√åNH DUY·ªÜT T·ª∞ M·ªû FILE KHI K√âO TH·∫¢ (FIX L·ªñI QUAN TR·ªåNG) ===
  window.addEventListener("dragover", function(e){
    e = e || event;
    e.preventDefault();
  }, false);

  window.addEventListener("drop", function(e){
    e = e || event;
    e.preventDefault();
  }, false);
  // ===================================================================

  const $ = (id) => document.getElementById(id);
  const logBox = $('logBox');
  
  let splitFileBytes = null;
  let splitFileName = '';
  let splitMode = 'single';
  let mergeFiles = [];

  // --- UI SWITCHING ---
  function setApp(app) {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    $('app-split').classList.add('hidden');
    $('app-merge').classList.add('hidden');
    $(app === 'split' ? 'app-split' : 'app-merge').classList.remove('hidden');
  }

  function setMode(mode, el) {
    splitMode = mode;
    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    ['single', 'custom', 'size'].forEach(m => $(`mode-${m}`).classList.add('hidden'));
    $(`mode-${mode}`).classList.remove('hidden');
  }

  function log(msg) {
    logBox.innerHTML += `<div>> ${msg}</div>`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  // --- DRAG & DROP HANDLERS ---
  function setupDrop(elemId, callback) {
    const el = $(elemId);
    el.addEventListener('dragenter', () => el.classList.add('dragover'));
    el.addEventListener('dragleave', () => el.classList.remove('dragover'));
    el.addEventListener('drop', (e) => {
      el.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if(files.length > 0) callback(files);
    });
    // Input click fallback
    const input = el.querySelector('input');
    input.addEventListener('change', () => {
      if(input.files.length > 0) callback(input.files);
    });
  }

  // --- LOGIC: SPLIT ---
  setupDrop('dropSplit', async (files) => {
    const f = files[0];
    if(f.type !== 'application/pdf') return alert("Vui l√≤ng ch·ªâ ch·ªçn file PDF!");
    
    $('splitFileInfo').textContent = `‚úÖ ƒê√£ nh·∫≠n: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
    splitFileBytes = await f.arrayBuffer();
    splitFileName = f.name.replace('.pdf', '');
    $('btnDoSplit').disabled = false;
    log(`ƒê√£ n·∫°p file: ${f.name}`);
  });

  $('btnDoSplit').addEventListener('click', async () => {
    if(!splitFileBytes) return;
    const btn = $('btnDoSplit');
    btn.disabled = true; btn.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
    
    try {
      const pdfDoc = await PDFLib.PDFDocument.load(splitFileBytes);
      const totalPages = pdfDoc.getPageCount();
      const zip = new JSZip();
      let groups = [];
      let names = [];

      // 1. X√°c ƒë·ªãnh c√°ch chia
      if (splitMode === 'single') {
        for(let i=0; i<totalPages; i++) groups.push([i]); // 0-based index
        names = $('splitNames').value.split('\n').map(s => s.trim());
      } 
      else if (splitMode === 'custom') {
        // Parse c√¥ng th·ª©c: 1-5 | 8 | 10
        const raw = $('customRange').value;
        const parts = raw.split('|');
        
        parts.forEach(part => {
          let pages = [];
          // T√°ch d·∫•u ph·∫©y tr∆∞·ªõc (cho tr∆∞·ªùng h·ª£p 1,3,5)
          part.split(',').forEach(sub => {
             if(sub.includes('-')) {
               let [start, end] = sub.split('-').map(Number);
               if(start && end) {
                 for(let k=start; k<=end; k++) if(k <= totalPages) pages.push(k-1);
               }
             } else {
               let p = parseInt(sub);
               if(p && p <= totalPages) pages.push(p-1);
             }
          });
          if(pages.length) groups.push(pages);
        });
        names = $('customNames').value.split('\n').map(s => s.trim());
      }
      else if (splitMode === 'size') {
        log("ƒêang qu√©t dung l∆∞·ª£ng c√°c trang...");
        const maxBytes = parseFloat($('splitMaxMB').value) * 1024 * 1024;
        let currentGroup = [];
        let currentSize = 0;

        for(let i=0; i<totalPages; i++) {
          // Copy th·ª≠ 1 trang ra ƒë·ªÉ ƒëo
          const tempDoc = await PDFLib.PDFDocument.create();
          const [cp] = await tempDoc.copyPages(pdfDoc, [i]);
          tempDoc.addPage(cp);
          const b = await tempDoc.save();
          
          if(currentGroup.length > 0 && (currentSize + b.length > maxBytes)) {
             groups.push(currentGroup);
             currentGroup = [];
             currentSize = 0;
          }
          currentGroup.push(i);
          currentSize += b.length;
        }
        if(currentGroup.length) groups.push(currentGroup);
      }

      // 2. Th·ª±c hi·ªán t√°ch v√† n√©n ZIP
      if(groups.length === 0) throw new Error("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c trang n√†o ƒë·ªÉ t√°ch!");

      for(let i=0; i<groups.length; i++) {
        const newPdf = await PDFLib.PDFDocument.create();
        const copiedPages = await newPdf.copyPages(pdfDoc, groups[i]);
        copiedPages.forEach(p => newPdf.addPage(p));
        const pdfBytes = await newPdf.save();

        let fName = "File_" + (i+1);
        if(names[i] && names[i] !== "") fName = names[i];
        
        // Clean t√™n file
        fName = fName.replace(/[\\/:*?"<>|]/g, "_");
        zip.file(`${fName}.pdf`, pdfBytes);
        log(`+ ƒê√£ t·∫°o: ${fName}.pdf`);
      }

      // 3. T·∫£i v·ªÅ
      const content = await zip.generateAsync({type:"blob"});
      download(content, `${splitFileName}_Split.zip`);
      log("‚úÖ Xong! ƒêang t·∫£i file ZIP.");

    } catch(err) {
      alert("L·ªói: " + err.message);
      log("‚ùå L·ªói: " + err.message);
    }
    btn.disabled = false; btn.textContent = "üöÄ T√°ch File Ngay";
  });


  // --- LOGIC: MERGE ---
  setupDrop('dropMerge', async (files) => {
    for(let f of files) {
      if(f.type === 'application/pdf') {
        const buf = await f.arrayBuffer();
        mergeFiles.push({ name: f.name, data: buf });
      }
    }
    renderMergeList();
  });

  function renderMergeList() {
    const div = $('mergeList');
    div.innerHTML = '';
    mergeFiles.forEach((f, i) => {
      div.innerHTML += `<span class="file-tag">${i+1}. ${f.name} <b style="cursor:pointer; color:red; margin-left:5px" onclick="removeMerge(${i})">x</b></span>`;
    });
    $('btnDoMerge').disabled = mergeFiles.length < 2;
  }
  
  window.removeMerge = (idx) => {
    mergeFiles.splice(idx, 1);
    renderMergeList();
  }

  $('btnDoMerge').addEventListener('click', async () => {
    const btn = $('btnDoMerge');
    btn.disabled = true; btn.textContent = "‚è≥ ƒêang gh√©p...";
    try {
      const mergedPdf = await PDFLib.PDFDocument.create();
      for (let file of mergeFiles) {
        const src = await PDFLib.PDFDocument.load(file.data);
        const indices = src.getPageIndices();
        const copied = await mergedPdf.copyPages(src, indices);
        copied.forEach(p => mergedPdf.addPage(p));
        log(`+ ƒê√£ gh√©p: ${file.name}`);
      }
      const bytes = await mergedPdf.save();
      const blob = new Blob([bytes], {type: "application/pdf"});
      download(blob, $('mergeOutName').value || "Merged.pdf");
      log("‚úÖ G·ªôp xong! ƒêang t·∫£i xu·ªëng.");
    } catch(err) {
      log("‚ùå L·ªói g·ªôp: " + err.message);
    }
    btn.disabled = false; btn.textContent = "üîó G·ªôp File Ngay";
  });

  function download(blob, name) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = name;
    a.click();
  }

</script>
</body>
</html>
