<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>baotg10 | Tool t√°ch PDF ‚Üí ZIP</title>

  <style>
    :root{
      color-scheme: dark;
      --bg0:#070b14;
      --bg1:#0b1220;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.12);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --muted2:#cbd5e1;
      --p1:#3b82f6;
      --p2:#8b5cf6;
      --p3:#ec4899;
      --ok:#22c55e;
      --err:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r:18px;
      --r2:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:28px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(800px 520px at 90% 10%, rgba(236,72,153,.22), transparent 55%),
        radial-gradient(900px 650px at 50% 100%, rgba(139,92,246,.22), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{max-width:1040px; margin:0 auto}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(59,130,246,.35), rgba(139,92,246,.25), rgba(236,72,153,.25));
      filter: blur(22px);
      opacity:.25;
      pointer-events:none;
    }
    .inner{position:relative; padding:18px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:18px 18px 6px 18px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(59,130,246,.95), rgba(139,92,246,.85) 55%, rgba(236,72,153,.85));
      box-shadow: 0 14px 30px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    h1{
      font-size:18px; margin:0;
      letter-spacing:.2px;
    }
    .subtitle{
      font-size:13px; color:var(--muted);
    }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:13px;
      color:var(--muted2);
      backdrop-filter: blur(10px);
    }

    /* Intro */
    .intro{
      margin:10px 18px 18px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .intro h2{
      margin:0 0 8px; font-size:15px;
    }
    .intro p{margin:0 0 10px; color:var(--muted); line-height:1.6; font-size:13.5px}
    .intro .grid{
      display:grid; gap:10px; grid-template-columns: 1.1fr .9fr;
    }
    @media (max-width:900px){ .intro .grid{grid-template-columns:1fr} }
    .feature{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:12px; border-radius: var(--r2);
    }
    .feature b{display:block; font-size:13.5px; margin-bottom:4px}
    .feature span{display:block; font-size:12.8px; color:var(--muted); line-height:1.5}
    .note{
      margin-top:10px;
      display:flex; gap:10px; align-items:flex-start;
      padding:12px; border-radius: var(--r2);
      border:1px solid rgba(34,197,94,.25);
      background: rgba(34,197,94,.08);
      color: #d1fae5;
      font-size:12.8px;
      line-height:1.5;
    }

    /* Form area */
    .section{
      margin:0 18px 18px;
      border-radius: var(--r);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .row{
      display:grid; gap:12px; grid-template-columns: 1.2fr .8fr;
    }
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    input[type="file"], input[type="text"], input[type="number"], textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.15);
    }
    textarea{min-height:220px; resize:vertical}

    .hint{font-size:12.8px; color:var(--muted); margin-top:6px; line-height:1.45}

    /* Mode cards */
    .modes{display:flex; flex-wrap:wrap; gap:10px; margin-top:12px}
    .mode{
      flex: 1 1 260px;
      display:flex; gap:10px; align-items:flex-start;
      padding:12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .mode:hover{
      transform: translateY(-1px);
      border-color: rgba(59,130,246,.35);
      background: rgba(255,255,255,.06);
    }
    .mode input{margin-top:4px; transform: scale(1.15)}
    .mode b{display:block; font-size:14px}
    .mode .sub{font-size:12.8px; color:var(--muted); line-height:1.45}

    .row2{display:grid; gap:12px; grid-template-columns:1fr 1fr; margin-top:12px}
    @media (max-width:820px){ .row2{grid-template-columns:1fr} }
    .hide{display:none !important}

    /* Buttons */
    .btns{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:12px}
    button{
      padding:11px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.85));
      color:#fff; cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      transition: transform .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.06); }
    button:active{ transform: translateY(0px); filter: brightness(.98); }
    button.secondary{
      background: rgba(255,255,255,.08);
      box-shadow:none;
      font-weight:700;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; filter:none; }

    .status{color:var(--muted2); font-size:13.5px}
    .progress{
      margin-top:14px;
      height: 12px;
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(59,130,246,.85));
      transition: width .15s ease;
    }
    .meta{margin-top:10px; color:var(--muted2); font-size:13.5px}
    .log{
      margin-top:12px;
      padding:12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      color: var(--text);
      max-height: 280px;
      overflow:auto;
    }
    .ok{color:#86efac}
    .err{color:#fca5a5}

    /* Footer */
    .footer{
      padding:14px 18px 18px;
      border-top:1px solid rgba(255,255,255,.08);
      color:rgba(148,163,184,.9);
      font-size:12.5px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
    }
    .footer b{color:#e5e7eb}
    .footer .right{opacity:.9}

    /* ===== Modal ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.75);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    .modal{
      width:min(920px, 100%);
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(2,6,23,.92));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      box-shadow: 0 26px 80px rgba(0,0,0,.60);
      overflow:hidden;
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(120deg, rgba(59,130,246,.30), rgba(139,92,246,.22), rgba(236,72,153,.22));
      filter: blur(26px);
      opacity:.35;
      pointer-events:none;
    }
    .modal .m-inner{position:relative}
    .modal header{
      padding:16px 18px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .modal header b{font-size:15px}
    .modal .content{padding:16px 18px}
    .modal .callout{
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--muted2);
      font-size:13px;
      line-height:1.5;
      margin-bottom:12px;
    }
    .modal footer{
      padding:14px 18px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* BIG toggle */
    .toggle-row{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      margin-bottom:12px;
    }
    .toggle-text{
      display:flex; flex-direction:column; gap:2px;
    }
    .toggle-text b{font-size:14px}
    .toggle-text span{font-size:12.8px; color:var(--muted); line-height:1.35}

    .switch{
      position:relative;
      width:64px; height:36px;
      flex: 0 0 auto;
    }
    .switch input{display:none}
    .slider{
      position:absolute; inset:0;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      transition: .18s ease;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.18);
    }
    .slider::before{
      content:"";
      position:absolute;
      width:28px; height:28px;
      left:4px; top:3px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.72));
      transition: .18s ease;
      box-shadow: 0 10px 24px rgba(0,0,0,.38);
    }
    .switch input:checked + .slider{
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(139,92,246,.85));
      border-color: rgba(59,130,246,.45);
    }
    .switch input:checked + .slider::before{
      transform: translateX(28px);
    }

    .kbd{
      padding:6px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:12.5px;
      color: var(--muted2);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <h1>Tool t√°ch PDF ‚Üí ZIP</h1>
            <div class="subtitle">T√°ch l·∫ª ‚Ä¢ T√°ch theo nh√≥m ‚Ä¢ T√°ch theo dung l∆∞·ª£ng ‚Äî ch·∫°y tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát</div>
          </div>
        </div>
        <div class="pill">
          <span>Powered by</span> <b>baotg10</b>
        </div>
      </div>

      <!-- GI·ªöI THI·ªÜU TOOL -->
      <div class="intro">
        <h2>Gi·ªõi thi·ªáu</h2>
        <div class="grid">
          <div class="feature">
            <b>Tool n√†y l√†m ƒë∆∞·ª£c g√¨?</b>
            <span>
              Ch·ªçn 1 file PDF ‚Üí t√°ch ra nhi·ªÅu file PDF theo 3 ki·ªÉu (t√°ch l·∫ª t·ª´ng trang, t√°ch theo nh√≥m trang b·∫°n nh·∫≠p, ho·∫∑c t·ª± chia theo dung l∆∞·ª£ng),
              sau ƒë√≥ n√©n t·∫•t c·∫£ v√†o 1 file ZIP ƒë·ªÉ t·∫£i v·ªÅ.
            </span>
          </div>
          <div class="feature">
            <b>Ch·∫°y ·ªü ƒë√¢u? C√≥ an to√†n kh√¥ng?</b>
            <span>
              Tool ch·∫°y tr√™n tr√¨nh duy·ªát (Chrome/Edge). D·ªØ li·ªáu x·ª≠ l√Ω ngay tr√™n m√°y b·∫°n.
              L∆∞u √Ω: v√¨ d√πng th∆∞ vi·ªán t·∫£i qua CDN n√™n c·∫ßn Internet l√∫c m·ªü trang.
            </span>
          </div>

          <div class="feature">
            <b>C√°ch d√πng nhanh</b>
            <span>
              1) Ch·ªçn PDF ‚Üí 2) Ch·ªçn ch·∫ø ƒë·ªô t√°ch ‚Üí 3) (n·∫øu c·∫ßn) nh·∫≠p nh√≥m/dung l∆∞·ª£ng ‚Üí 4) B·∫•m ‚ÄúT√°ch & T·∫£i ZIP‚Äù.
            </span>
          </div>
          <div class="feature">
            <b>L∆∞u √Ω file scan</b>
            <span>
              N·∫øu PDF l√† b·∫£n scan, c·∫ßn ƒë·∫£m b·∫£o th·ª© t·ª± trang ƒë√∫ng. Khi ‚Äút√°ch l·∫ª + ƒë·∫∑t t√™n‚Äù, m·ªói d√≤ng t√™n s·∫Ω ·ª©ng v·ªõi trang 1 ‚Üí n theo ƒë√∫ng th·ª© t·ª±.
            </span>
          </div>
        </div>

        <div class="note">
          ‚úÖ M·∫πo: N·∫øu b·∫°n mu·ªën ƒë·∫∑t t√™n nhanh theo danh s√°ch (m·ªói d√≤ng 1 t√™n), h√£y chu·∫©n b·ªã s·∫µn trong Excel/Word r·ªìi copy d√°n v√†o.
        </div>
      </div>

      <div class="inner">
        <div class="section">
          <div class="row">
            <div>
              <input id="file" type="file" accept="application/pdf" />
              <div class="hint">PDF scan n·∫∑ng c√≥ th·ªÉ ch·∫°y ch·∫≠m do gi·ªõi h·∫°n RAM tr√¨nh duy·ªát.</div>
            </div>
            <div>
              <input id="zipname" type="text" placeholder="T√™n ZIP (tu·ª≥ ch·ªçn) - ƒë·ªÉ tr·ªëng = t·ª± ƒë·∫∑t" />
              <div class="hint">V√≠ d·ª•: split_ho_so_001.zip</div>
            </div>
          </div>

          <div class="modes">
            <label class="mode">
              <input type="radio" name="mode" value="single" checked />
              <div>
                <b>T√°ch l·∫ª t·ª´ng trang</b>
                <div class="sub">M·ªói trang = 1 file PDF. Khi b·∫•m t√°ch s·∫Ω h·ªèi c√≥ mu·ªën ƒë·∫∑t t√™n theo danh s√°ch kh√¥ng.</div>
              </div>
            </label>

            <label class="mode">
              <input type="radio" name="mode" value="custom" />
              <div>
                <b>T√°ch theo y√™u c·∫ßu</b>
                <div class="sub">B·∫°n nh·∫≠p nh√≥m trang, v√≠ d·ª•: <b>1-3|4-6|7,9|10</b>.</div>
              </div>
            </label>

            <label class="mode">
              <input type="radio" name="mode" value="size" />
              <div>
                <b>T√°ch theo dung l∆∞·ª£ng</b>
                <div class="sub">T·ª± chia sao cho m·ªói file ‚â§ X MB (tr·ª´ trang ƒë∆°n l·∫ª qu√° l·ªõn).</div>
              </div>
            </label>
          </div>

          <div id="customBox" class="row2 hide">
            <div>
              <input id="customSpec" type="text" placeholder="Nh·∫≠p nh√≥m trang: 1-3|4-6|7,9|10" />
              <div class="hint">
                D√πng <b>|</b> ƒë·ªÉ ngƒÉn nh√≥m. Trong m·ªói nh√≥m c√≥ th·ªÉ d√πng <b>,</b> v√† <b>-</b>.
                V√≠ d·ª•: <b>1-5|6-10</b> ‚Üí ra 2 file.
              </div>
            </div>
            <div>
              <input id="customPrefix" type="text" placeholder="Ti·ªÅn t·ªë t√™n file (tu·ª≥ ch·ªçn) - vd: HO_SO" />
              <div class="hint">N·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng t√™n PDF g·ªëc.</div>
            </div>
          </div>

          <div id="sizeBox" class="row2 hide">
            <div>
              <input id="maxMB" type="number" min="0.1" step="0.1" value="5" />
              <div class="hint">Gi·ªõi h·∫°n dung l∆∞·ª£ng m·ªói file (MB). V√≠ d·ª• 5 MB.</div>
            </div>
            <div>
              <input id="sizePrefix" type="text" placeholder="Ti·ªÅn t·ªë t√™n file (tu·ª≥ ch·ªçn) - vd: PART" />
              <div class="hint">N·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng t√™n PDF g·ªëc.</div>
            </div>
          </div>

          <div class="btns">
            <button id="btnSplit" disabled>T√°ch & T·∫£i ZIP</button>
            <button id="btnInfo" class="secondary" disabled>Xem th√¥ng tin PDF</button>
            <span id="status" class="status"></span>
          </div>

          <div class="progress"><div class="bar" id="bar"></div></div>
          <div class="meta" id="meta"></div>
          <div class="log" id="log"></div>

          <div class="hint" style="margin-top:10px">
            L∆∞u √Ω ch·∫ø ƒë·ªô dung l∆∞·ª£ng: tool <b>ƒëo k√≠ch th∆∞·ªõc file PDF t·∫°o ra th·ª±c t·∫ø</b> ƒë·ªÉ quy·∫øt ƒë·ªãnh c·∫Øt.
            N·∫øu <b>1 trang</b> ƒë√£ > X MB th√¨ file ƒë√≥ v·∫´n > X MB (kh√¥ng th·ªÉ nh·ªè h∆°n).
          </div>
        </div>
      </div>

      <div class="footer">
        <div><b>¬© baotg10</b> ‚Äî Tool t√°ch PDF & ZIP</div>
        <div class="right">Made for fast workflow ‚Ä¢ 2025</div>
      </div>
    </div>
  </div>

  <!-- ===== Modal ƒë·∫∑t t√™n (ch·ªâ cho t√°ch l·∫ª) ===== -->
  <div class="modal-overlay" id="nameModalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="m-inner">
        <header>
          <b>ƒê·∫∑t t√™n file khi t√°ch l·∫ª t·ª´ng trang</b>
          <div class="pill"><span>Trang:</span> <b id="modalPageCount">0</b></div>
        </header>

        <div class="content">
          <div class="callout">
            ‚úÖ N·∫øu b·∫°n b·∫≠t ƒë·∫∑t t√™n: <b>m·ªói d√≤ng = 1 file</b> (t∆∞∆°ng ·ª©ng theo <b>th·ª© t·ª± trang</b> t·ª´ 1 ‚Üí n).<br/>
            üìå <b>Ghi ch√∫:</b> N·∫øu l√† <b>file scan</b>, nh·ªõ s·∫Øp x·∫øp/ki·ªÉm tra ƒë√∫ng th·ª© t·ª± trang ƒë·ªÉ kh·ªõp danh s√°ch t√™n n√†y.
          </div>

          <div class="toggle-row">
            <div class="toggle-text">
              <b>B·∫≠t ƒë·∫∑t t√™n theo danh s√°ch</b>
              <span>N·∫øu t·∫Øt: t·ª± ƒë·∫∑t t√™n theo d·∫°ng <b>tenPDF_p01.pdf</b>, <b>tenPDF_p02.pdf</b>...</span>
            </div>

            <label class="switch" title="B·∫≠t/T·∫Øt ƒë·∫∑t t√™n theo danh s√°ch">
              <input type="checkbox" id="chkUseNames" />
              <span class="slider"></span>
            </label>
          </div>

          <textarea id="namesText" class="hide" placeholder="D√°n danh s√°ch t√™n t·∫°i ƒë√¢y (m·ªói d√≤ng 1 t√™n)...
V√≠ d·ª•:
CMND_NguyenVanA
SoHoKhau_NguyenVanA
GiayDangKyKetHon"></textarea>

          <div class="hint" id="namesHint"></div>
          <div class="hint" style="margin-top:8px">
            Ph√≠m nhanh: <span class="kbd">Esc</span> ƒë·ªÉ hu·ª∑.
          </div>
        </div>

        <footer>
          <button class="secondary" id="btnModalCancel">Hu·ª∑</button>
          <button id="btnModalContinue">Ti·∫øp t·ª•c</button>
        </footer>
      </div>
    </div>
  </div>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const fileInput = $("file");
    const zipNameInput = $("zipname");

    const customBox = $("customBox");
    const sizeBox   = $("sizeBox");
    const customSpec = $("customSpec");
    const customPrefix = $("customPrefix");
    const maxMB = $("maxMB");
    const sizePrefix = $("sizePrefix");

    const btnSplit = $("btnSplit");
    const btnInfo  = $("btnInfo");
    const statusEl = $("status");
    const metaEl   = $("meta");
    const logEl    = $("log");
    const barEl    = $("bar");

    // Modal
    const nameModalOverlay = $("nameModalOverlay");
    const modalPageCount = $("modalPageCount");
    const chkUseNames = $("chkUseNames");
    const namesText = $("namesText");
    const namesHint = $("namesHint");
    const btnModalCancel = $("btnModalCancel");
    const btnModalContinue = $("btnModalContinue");

    let currentFile = null;
    let currentPdfBytes = null;
    let currentPageCount = 0;

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setBar(pct){ barEl.style.width = Math.max(0, Math.min(100, pct)) + "%"; }
    function clearLog(){ logEl.textContent = ""; metaEl.textContent = ""; setBar(0); setStatus(""); }
    function log(msg, cls){
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function getBaseName(name){ return (name || "file").replace(/\.[^.]+$/,""); }
    function padNumber(n, width){
      const s = String(n);
      return s.length >= width ? s : ("0".repeat(width - s.length) + s);
    }

    function sanitizeFileName(name){
      let s = (name || "").trim();
      s = s.replace(/[\/\\:\*\?"<>\|]/g, " ");
      s = s.replace(/\s+/g, " ").trim();
      return s;
    }

    function ensureUniqueName(baseName, usedMap){
      const key = baseName.toLowerCase();
      if (!usedMap.has(key)){
        usedMap.set(key, 1);
        return baseName;
      }
      const n = usedMap.get(key) + 1;
      usedMap.set(key, n);
      return `${baseName} (${n})`;
    }

    function parsePageRanges(text, maxPage){
      const t = (text || "").trim();
      if (!t) return [];
      const parts = t.split(",").map(x=>x.trim()).filter(Boolean);
      const out = new Set();

      for (const part of parts){
        const m = part.match(/^(\d+)\s*-\s*(\d+)$/);
        if (m){
          let a = parseInt(m[1],10);
          let b = parseInt(m[2],10);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a > b) [a,b] = [b,a];
          for (let i=a;i<=b;i++){
            if (i>=1 && i<=maxPage) out.add(i);
          }
        } else {
          const n = parseInt(part,10);
          if (Number.isFinite(n) && n>=1 && n<=maxPage) out.add(n);
        }
      }
      return Array.from(out).sort((x,y)=>x-y);
    }

    function parseGroups(spec, maxPage){
      const s = (spec || "").trim();
      if (!s) return [];
      const rawGroups = s.split("|").map(x=>x.trim()).filter(Boolean);
      const groups = [];
      for (const g of rawGroups){
        const pages = parsePageRanges(g, maxPage);
        if (pages.length) groups.push(pages);
      }
      return groups;
    }

    async function loadPdfFromFile(file){
      const buf = await file.arrayBuffer();
      currentPdfBytes = new Uint8Array(buf);
      const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
      currentPageCount = pdfDoc.getPageCount();
      return pdfDoc;
    }

    function getMode(){
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : "single";
    }

    function refreshModeUI(){
      const mode = getMode();
      customBox.classList.toggle("hide", mode !== "custom");
      sizeBox.classList.toggle("hide", mode !== "size");
    }
    document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", refreshModeUI));
    refreshModeUI();

    // ===== Modal logic =====
    function openNameModal(pageCount){
      modalPageCount.textContent = String(pageCount);
      chkUseNames.checked = false;
      namesText.value = "";
      namesText.classList.add("hide");
      namesHint.textContent = "";
      nameModalOverlay.style.display = "flex";
      setTimeout(() => btnModalContinue.focus(), 30);
    }

    function closeNameModal(){
      nameModalOverlay.style.display = "none";
    }

    chkUseNames.addEventListener("change", () => {
      const on = chkUseNames.checked;
      namesText.classList.toggle("hide", !on);
      namesHint.textContent = on
        ? "M·∫πo: Copy t·ª´ Excel/Word: m·ªói d√≤ng 1 t√™n. D√≤ng n√†o ƒë·ªÉ tr·ªëng ‚Üí trang ƒë√≥ s·∫Ω d√πng t√™n m·∫∑c ƒë·ªãnh."
        : "";
      if (on) setTimeout(() => namesText.focus(), 30);
    });

    function askNamesForSingleSplit(pageCount){
      return new Promise((resolve) => {
        openNameModal(pageCount);

        const onCancel = () => {
          cleanup();
          closeNameModal();
          resolve(null);
        };

        const onContinue = () => {
          const useNames = chkUseNames.checked;
          const linesRaw = (namesText.value || "").replace(/\r\n/g, "\n").split("\n");
          cleanup();
          closeNameModal();
          resolve({ useNames, linesRaw });
        };

        const onKey = (e) => {
          if (e.key === "Escape") onCancel();
        };

        function cleanup(){
          btnModalCancel.removeEventListener("click", onCancel);
          btnModalContinue.removeEventListener("click", onContinue);
          document.removeEventListener("keydown", onKey);
        }

        btnModalCancel.addEventListener("click", onCancel);
        btnModalContinue.addEventListener("click", onContinue);
        document.addEventListener("keydown", onKey);
      });
    }

    fileInput.addEventListener("change", async () => {
      clearLog();
      const f = fileInput.files && fileInput.files[0];
      currentFile = f || null;

      btnSplit.disabled = true;
      btnInfo.disabled = true;

      if (!currentFile){ return; }

      setStatus("ƒêang ƒë·ªçc PDF...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("S·∫µn s√†ng");
        btnSplit.disabled = false;
        btnInfo.disabled = false;

        metaEl.textContent =
          `T√™n file: ${currentFile.name} | Dung l∆∞·ª£ng: ${(currentFile.size/1024/1024).toFixed(2)} MB | S·ªë trang: ${currentPageCount}`;
        log("ƒê√£ t·∫£i PDF th√†nh c√¥ng.", "ok");
      } catch (e){
        setStatus("L·ªói ƒë·ªçc PDF");
        log("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c PDF. C√≥ th·ªÉ file b·ªã m√£ ho√° ho·∫∑c h·ªèng.", "err");
        log(String(e), "err");
      }
    });

    btnInfo.addEventListener("click", async () => {
      if (!currentFile) return;
      clearLog();
      setStatus("ƒêang l·∫•y th√¥ng tin...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("Xong");
        metaEl.textContent = `S·ªë trang: ${currentPageCount}`;
        log(`PDF c√≥ ${currentPageCount} trang.`, "ok");
        log(`V√≠ d·ª• theo y√™u c·∫ßu: 1-3|4-6|7,9|10`);
        log(`V√≠ d·ª• theo dung l∆∞·ª£ng: nh·∫≠p 5 (MB) ƒë·ªÉ chia m·ªói file <= 5MB.`);
      } catch (e){
        setStatus("L·ªói");
        log(String(e), "err");
      }
    });

    async function buildPdfBytesFromPages(srcDoc, pages1Based){
      const newDoc = await PDFLib.PDFDocument.create();
      const idx0 = pages1Based.map(p => p-1);
      const copied = await newDoc.copyPages(srcDoc, idx0);
      copied.forEach(pg => newDoc.addPage(pg));
      const bytes = await newDoc.save();
      return bytes;
    }

    function pagesLabel(pages, width){
      if (!pages.length) return "p";
      const a = padNumber(pages[0], width);
      const b = padNumber(pages[pages.length-1], width);
      return (pages.length === 1) ? `p${a}` : `p${a}-${b}`;
    }

    btnSplit.addEventListener("click", async () => {
      if (!currentFile || !currentPdfBytes) return;

      clearLog();
      btnSplit.disabled = true;
      btnInfo.disabled = true;

      try{
        const mode = getMode();
        setStatus("ƒêang m·ªü PDF...");
        const srcDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
        const pageCount = srcDoc.getPageCount();
        const width = String(pageCount).length;

        const baseFromFile = getBaseName(currentFile.name);
        const zip = new JSZip();
        const zipName = (zipNameInput.value || "").trim() || `${baseFromFile}_split.zip`;

        log(`Ch·∫ø ƒë·ªô: ${mode}`, "ok");
        log(`T·ªïng trang: ${pageCount}`, "ok");

        let groups = [];

        let singleNameLines = null;
        let useSingleNames = false;

        if (mode === "single"){
          const modalResult = await askNamesForSingleSplit(pageCount);
          if (!modalResult){
            setStatus("ƒê√£ hu·ª∑");
            log("B·∫°n ƒë√£ hu·ª∑ thao t√°c.", "err");
            return;
          }
          useSingleNames = modalResult.useNames;
          singleNameLines = modalResult.linesRaw;

          if (useSingleNames){
            log("ƒêang d√πng danh s√°ch t√™n (m·ªói d√≤ng = 1 trang).", "ok");
            log("Ghi ch√∫: File scan nh·ªõ ƒë√∫ng th·ª© t·ª± trang ƒë·ªÉ kh·ªõp t√™n.", "ok");
          } else {
            log("Kh√¥ng ƒë·∫∑t t√™n theo danh s√°ch ‚Üí d√πng t√™n m·∫∑c ƒë·ªãnh.", "ok");
          }

          groups = Array.from({length: pageCount}, (_,i)=>[i+1]);
        }

        if (mode === "custom"){
          const spec = (customSpec.value || "").trim();
          groups = parseGroups(spec, pageCount);
          if (!groups.length){
            throw new Error("Ch·∫ø ƒë·ªô 'theo y√™u c·∫ßu' c·∫ßn nh·∫≠p nh√≥m trang. V√≠ d·ª•: 1-3|4-6|7,9|10");
          }
        }

        if (mode === "size"){
          const limitMB = Number(maxMB.value);
          if (!Number.isFinite(limitMB) || limitMB <= 0) {
            throw new Error("Dung l∆∞·ª£ng (MB) kh√¥ng h·ª£p l·ªá.");
          }
          const maxBytes = Math.floor(limitMB * 1024 * 1024);

          let currentPages = [];
          let currentBytes = null;

          const finalizeCurrent = () => {
            if (currentPages.length && currentBytes) {
              groups.push({ pages: currentPages.slice(), bytes: currentBytes });
            }
          };

          setStatus("ƒêang chia nh√≥m theo dung l∆∞·ª£ng...");
          for (let p = 1; p <= pageCount; p++){
            const candidatePages = currentPages.concat([p]);
            const candidateBytes = await buildPdfBytesFromPages(srcDoc, candidatePages);

            if (candidateBytes.length <= maxBytes || currentPages.length === 0){
              currentPages = candidatePages;
              currentBytes = candidateBytes;

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);

              if (candidateBytes.length > maxBytes && currentPages.length === 1){
                log(`Trang ${p} ri√™ng l·∫ª ƒë√£ ${(candidateBytes.length/1024/1024).toFixed(2)} MB > ${limitMB} MB (b·∫Øt bu·ªôc).`, "err");
              }
            } else {
              finalizeCurrent();
              currentPages = [p];
              currentBytes = await buildPdfBytesFromPages(srcDoc, currentPages);

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);
            }
          }
          finalizeCurrent();

          log(`ƒê√£ chia th√†nh ${groups.length} file theo dung l∆∞·ª£ng ~‚â§ ${limitMB} MB.`, "ok");
        }

        setStatus("ƒêang t·∫°o file & ƒë∆∞a v√†o ZIP...");
        let outCount = 0;

        if (mode === "size"){
          const prefix = (sizePrefix.value || "").trim() || baseFromFile;

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i].pages;
            const bytes = groups[i].bytes;
            const label = pagesLabel(pages, width);
            const fname = `${prefix}_${padNumber(i+1, 2)}_${label}.pdf`;

            zip.file(fname, bytes);
            outCount++;

            const pct = 55 + Math.round(((i+1)/groups.length) * 30);
            setBar(pct);

            log(`+ ${fname} (${(bytes.length/1024/1024).toFixed(2)} MB)`);
          }
        } else {
          const prefix = (mode === "custom")
            ? ((customPrefix.value || "").trim() || baseFromFile)
            : baseFromFile;

          const usedNames = new Map();

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i];
            const bytes = await buildPdfBytesFromPages(srcDoc, pages);

            if (mode === "single") {
              const pageNo = pages[0];
              let fnameBase;

              if (useSingleNames) {
                const raw = (singleNameLines && singleNameLines[pageNo - 1]) ? singleNameLines[pageNo - 1] : "";
                const cleaned = sanitizeFileName(raw).replace(/\.pdf$/i, "").trim();

                if (cleaned) {
                  fnameBase = ensureUniqueName(cleaned, usedNames);
                } else {
                  fnameBase = `${prefix}_${pagesLabel(pages, width)}`;
                }
              } else {
                fnameBase = `${prefix}_${pagesLabel(pages, width)}`;
              }

              const fname = `${fnameBase}.pdf`;
              zip.file(fname, bytes);
              outCount++;

              const pct = 55 + Math.round(((i+1)/groups.length) * 30);
              setBar(pct);

              if ((i+1) % 5 === 0 || i === groups.length - 1) log(`ƒê√£ t·∫°o ${i+1}/${groups.length} file...`);
            } else {
              const fname = `${prefix}_${padNumber(i+1, 2)}_${pagesLabel(pages, width)}.pdf`;
              zip.file(fname, bytes);
              outCount++;

              const pct = 55 + Math.round(((i+1)/groups.length) * 30);
              setBar(pct);

              if ((i+1) % 3 === 0 || i === groups.length - 1) log(`ƒê√£ t·∫°o ${i+1}/${groups.length} file...`);
            }
          }
        }

        setStatus("ƒêang n√©n ZIP...");
        setBar(90);

        const zipBlob = await zip.generateAsync({ type: "blob" }, (meta) => {
          const pct = 90 + Math.round((meta.percent/100)*10);
          setBar(pct);
        });

        downloadBlob(zipBlob, zipName);
        setStatus("Ho√†n t·∫•t ‚úÖ");
        setBar(100);
        log(`ƒê√£ t·∫°o ${outCount} file PDF v√† n√©n v√†o: ${zipName}`, "ok");

      } catch (e){
        setStatus("C√≥ l·ªói ‚ùå");
        log("L·ªói:", "err");
        log(String(e), "err");
      } finally {
        btnSplit.disabled = false;
        btnInfo.disabled = false;
      }
    });
  </script>
</body>
</html>
