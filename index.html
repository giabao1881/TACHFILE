<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T√°ch PDF Si√™u T·ªëc | Clean UI</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb;       /* Xanh d∆∞∆°ng hi·ªán ƒë·∫°i */
      --primary-hover: #1d4ed8;
      --bg: #f3f4f6;            /* X√°m nh·∫°t n·ªÅn */
      --card-bg: #ffffff;
      --text-main: #1f2937;
      --text-sub: #6b7280;
      --border: #e5e7eb;
      --success: #10b981;
      --error: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      line-height: 1.5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    /* HEADER */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      margin: 0;
      font-size: 28px;
      color: var(--text-main);
      font-weight: 700;
    }
    .header p {
      margin-top: 8px;
      color: var(--text-sub);
    }

    /* MAIN CARD */
    .main-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
      border: 1px solid var(--border);
    }

    /* STEP 1: UPLOAD */
    .step-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .step-badge {
      background: var(--primary);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #f9fafb;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--primary);
      background: #eff6ff;
    }
    .upload-icon {
      font-size: 40px;
      color: var(--text-sub);
      margin-bottom: 10px;
    }
    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: #ecfdf5;
      color: #065f46;
      border-radius: 8px;
      display: none; /* Hi·ªán khi c√≥ file */
      font-size: 14px;
      border: 1px solid #a7f3d0;
    }

    /* STEP 2: MODES */
    .modes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .mode-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 15px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .mode-card:hover { border-color: var(--primary); }
    .mode-card.selected {
      border-color: var(--primary);
      background: #eff6ff;
      box-shadow: 0 0 0 2px var(--primary);
    }
    .mode-card input { position: absolute; opacity: 0; } /* Hide radio */
    
    .mode-title { font-weight: 600; display: block; margin-bottom: 4px; }
    .mode-desc { font-size: 13px; color: var(--text-sub); }

    /* CONTROLS (Inputs) */
    .controls-area {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    .hidden { display: none !important; }

    label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 6px; }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      transition: border 0.2s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    .hint { font-size: 12px; color: var(--text-sub); margin-top: 5px; }

    /* ACTION BUTTONS */
    .action-bar {
      margin-top: 30px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      font-size: 15px;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
      flex: 1;
    }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; }
    
    .btn-secondary {
      background: white;
      border: 1px solid var(--border);
      color: var(--text-main);
    }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }

    /* PROGRESS & LOG */
    .progress-wrap { margin-top: 20px; display: none; }
    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      width: 0%;
      background: var(--success);
      transition: width 0.3s ease;
    }
    .status-text { text-align: center; font-size: 14px; margin-top: 8px; color: var(--text-sub); }

    .log-box {
      margin-top: 20px;
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }
    .log-item { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; }
    .log-err { color: #fca5a5; }

    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center; justify-content: center;
      z-index: 100;
      backdrop-filter: blur(2px);
    }
    .modal-content {
      background: white;
      width: 90%; max-width: 500px;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .modal-header { font-weight: 700; font-size: 18px; margin-bottom: 15px; }
    .switch-wrap {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px;
    }
    .modal-actions {
      display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;
    }

    /* Footer */
    .footer {
      text-align: center; margin-top: 40px; font-size: 12px; color: #9ca3af;
    }
  </style>
</head>

<body>

<div class="container">
  <div class="header">
    <h1>‚úÇÔ∏è T√°ch PDF & T·∫£i ZIP</h1>
    <p>C√¥ng c·ª• x·ª≠ l√Ω PDF ngay tr√™n tr√¨nh duy·ªát - An to√†n & Ri√™ng t∆∞</p>
  </div>

  <div class="main-card">
    
    <div class="step-title">
      <span class="step-badge">1</span> Ch·ªçn File PDF
    </div>
    <div class="upload-zone" id="dropZone">
      <div class="upload-icon">üìÇ</div>
      <div style="font-weight: 500;">K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn</div>
      <div style="font-size: 13px; color: #9ca3af; margin-top: 5px;">H·ªó tr·ª£ file PDF m·ªçi k√≠ch th∆∞·ªõc</div>
      <input type="file" id="file" accept="application/pdf" style="display: none;" />
    </div>
    <div class="file-info" id="fileInfo"></div>

    <div style="height: 30px;"></div>

    <div class="step-title">
      <span class="step-badge">2</span> Ch·ªçn Ch·∫ø ƒê·ªô T√°ch
    </div>
    
    <div class="modes-grid">
      <label class="mode-card selected" onclick="selectMode('single', this)">
        <input type="radio" name="mode" value="single" checked>
        <span class="mode-title">T√°ch t·ª´ng trang</span>
        <span class="mode-desc">M·ªói trang th√†nh 1 file ri√™ng bi·ªát (1, 2, 3...)</span>
      </label>

      <label class="mode-card" onclick="selectMode('custom', this)">
        <input type="radio" name="mode" value="custom">
        <span class="mode-title">Ch·ªçn nh√≥m trang</span>
        <span class="mode-desc">V√≠ d·ª•: 1-5, 8, 10-15... theo √Ω mu·ªën</span>
      </label>

      <label class="mode-card" onclick="selectMode('size', this)">
        <input type="radio" name="mode" value="size">
        <span class="mode-title">Theo dung l∆∞·ª£ng</span>
        <span class="mode-desc">Chia nh·ªè file ƒë·ªÉ g·ª≠i email (v√≠ d·ª• < 5MB)</span>
      </label>
    </div>

    <div id="customBox" class="controls-area hidden">
      <label>Nh·∫≠p c√°c trang c·∫ßn l·∫•y:</label>
      <input id="customSpec" type="text" placeholder="V√≠ d·ª•: 1-3 | 4-6 | 7,9 | 10" />
      <div class="hint">
        D√πng d·∫•u <b>|</b> ƒë·ªÉ ng·∫Øt ra th√†nh c√°c file PDF kh√°c nhau.<br>
        V√≠ d·ª•: <b>1-3 | 5</b> s·∫Ω t·∫°o ra 2 file (m·ªôt file g·ªìm trang 1 ƒë·∫øn 3, m·ªôt file ch·ªâ trang 5).
      </div>
      
      <div style="margin-top: 15px;">
        <label>Danh s√°ch t√™n file (Tu·ª≥ ch·ªçn):</label>
        <textarea id="customNames" rows="3" placeholder="M·ªói d√≤ng m·ªôt t√™n t∆∞∆°ng ·ª©ng v·ªõi m·ªói nh√≥m ·ªü tr√™n..."></textarea>
      </div>
    </div>

    <div id="sizeBox" class="controls-area hidden">
      <label>Dung l∆∞·ª£ng t·ªëi ƒëa m·ªói file (MB):</label>
      <input id="maxMB" type="number" min="0.1" step="0.1" value="5" />
      <div class="hint">Tool s·∫Ω t·ª± ƒë·ªông g·ªôp c√°c trang sao cho file kh√¥ng v∆∞·ª£t qu√° s·ªë n√†y.</div>
    </div>

    <div style="margin-top: 15px;">
        <label style="font-weight: 500; font-size: 13px; color: var(--text-sub);">ƒê·∫∑t t√™n file ZIP (Tu·ª≥ ch·ªçn)</label>
        <input id="zipname" type="text" placeholder="ƒê·ªÉ tr·ªëng = t·ª± ƒë·ªông ƒë·∫∑t t√™n" style="margin-top: 4px;" />
    </div>

    <div class="action-bar">
      <button id="btnInfo" class="btn btn-secondary" disabled>Ki·ªÉm tra PDF</button>
      <button id="btnSplit" class="btn btn-primary" disabled>üöÄ T√°ch & T·∫£i Xu·ªëng</button>
    </div>

    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar"><div class="bar-fill" id="bar"></div></div>
      <div class="status-text" id="status">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <div class="log-box" id="log"></div>
  </div>

  <div class="footer">
    ¬© 2025 PDF Tool - X·ª≠ l√Ω ph√≠a Client (Kh√¥ng upload file l√™n server)
  </div>

</div>

<div class="modal-overlay" id="nameModalOverlay">
  <div class="modal-content">
    <div class="modal-header">ƒê·∫∑t t√™n file chi ti·∫øt</div>
    <div style="margin-bottom: 15px; font-size: 14px; color: #4b5563;">
      B·∫°n ƒëang t√°ch <b id="modalPageCount">0</b> trang. B·∫°n c√≥ mu·ªën ƒë·∫∑t t√™n ri√™ng cho t·ª´ng file kh√¥ng?
    </div>

    <div class="switch-wrap">
      <span>B·∫≠t danh s√°ch t√™n t√πy ch·ªânh</span>
      <input type="checkbox" id="chkUseNames" style="width: auto; margin:0; transform: scale(1.5);">
    </div>

    <textarea id="namesText" class="hidden" rows="6" placeholder="D√°n danh s√°ch t√™n v√†o ƒë√¢y.
D√≤ng 1 -> T√™n cho trang 1
D√≤ng 2 -> T√™n cho trang 2..."></textarea>
    <div class="hint" id="namesHint"></div>

    <div class="modal-actions">
      <button class="btn btn-secondary" id="btnModalCancel">Hu·ª∑ b·ªè</button>
      <button class="btn btn-primary" id="btnModalContinue">Ti·∫øp t·ª•c</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
    // --- KH·ªûI T·∫†O UI ---
    const $ = (id) => document.getElementById(id);
    const fileInput = $("file");
    const dropZone = $("dropZone");
    const fileInfo = $("fileInfo");
    const zipNameInput = $("zipname");
    
    // C√°c v√πng controls
    const customBox = $("customBox");
    const sizeBox = $("sizeBox");
    
    // Inputs
    const customSpec = $("customSpec");
    const customNames = $("customNames");
    const maxMB = $("maxMB");

    // Buttons & Status
    const btnSplit = $("btnSplit");
    const btnInfo = $("btnInfo");
    const statusEl = $("status");
    const barEl = $("bar");
    const logEl = $("log");
    const progressWrap = $("progressWrap");

    // Modal elements
    const nameModalOverlay = $("nameModalOverlay");
    const modalPageCount = $("modalPageCount");
    const chkUseNames = $("chkUseNames");
    const namesText = $("namesText");
    const namesHint = $("namesHint");
    const btnModalCancel = $("btnModalCancel");
    const btnModalContinue = $("btnModalContinue");

    let currentFile = null;
    let currentPdfBytes = null;
    let currentPageCount = 0;

    // --- LOGIC UI M·ªöI ---

    // X·ª≠ l√Ω ch·ªçn mode ƒë·∫πp m·∫Øt
    window.selectMode = function(mode, cardElement) {
        // Update UI th·∫ª
        document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
        cardElement.classList.add('selected');
        // Check radio input ·∫©n
        cardElement.querySelector('input').checked = true;

        // Hi·ªán/·∫©n box c·∫•u h√¨nh t∆∞∆°ng ·ª©ng
        customBox.classList.add('hidden');
        sizeBox.classList.add('hidden');
        if (mode === 'custom') customBox.classList.remove('hidden');
        if (mode === 'size') sizeBox.classList.remove('hidden');
    }

    // X·ª≠ l√Ω Drag & Drop
    dropZone.addEventListener("click", () => fileInput.click());
    
    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
    });
    
    dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
    });
    
    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
            handleFileSelect(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener("change", () => {
        if (fileInput.files.length) handleFileSelect(fileInput.files[0]);
    });

    async function handleFileSelect(file) {
        currentFile = file;
        
        // UI Update
        fileInfo.style.display = "block";
        fileInfo.innerHTML = `‚úÖ <b>ƒê√£ ch·ªçn:</b> ${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`;
        btnSplit.disabled = true;
        btnInfo.disabled = true;
        progressWrap.style.display = "block";
        setStatus("ƒêang ƒë·ªçc file...", 20);

        try {
            await loadPdfFromFile(currentFile);
            setStatus("S·∫µn s√†ng!", 100);
            setTimeout(() => { progressWrap.style.display = "none"; }, 1000);
            
            btnSplit.disabled = false;
            btnInfo.disabled = false;
            fileInfo.innerHTML += ` | <b>${currentPageCount} trang</b>`;
        } catch (e) {
            setStatus("L·ªói ƒë·ªçc file!", 0);
            fileInfo.innerHTML = `‚ùå L·ªói: Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file PDF n√†y.`;
            fileInfo.style.backgroundColor = "#fee2e2";
            fileInfo.style.color = "#b91c1c";
            fileInfo.style.borderColor = "#fca5a5";
        }
    }

    // --- C√ÅC H√ÄM LOGIC C·ªêT L√ïI (GI·ªÆ NGUY√äN T·ª™ SOURCE G·ªêC NH∆ØNG C·∫§U TR√öC L·∫†I) ---
    [cite_start]// [cite: 324]
    async function loadPdfFromFile(file){
      const buf = await file.arrayBuffer();
      currentPdfBytes = new Uint8Array(buf);
      const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
      currentPageCount = pdfDoc.getPageCount();
      return pdfDoc;
    }

    function setStatus(msg, pct){ 
        statusEl.textContent = msg || "";
        if(pct !== undefined) barEl.style.width = pct + "%";
    }

    function log(msg, cls){
        logEl.style.display = "block";
        const line = document.createElement("div");
        line.className = "log-item " + (cls ? "log-err" : "");
        line.textContent = "> " + msg;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
    }

    [cite_start]// [cite: 310]
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    [cite_start]// [cite: 312] Helpers
    function getBaseName(name){ return (name || "file").replace(/\.[^.]+$/,""); }
    function padNumber(n, width){ const s = String(n); return s.length >= width ? s : ("0".repeat(width - s.length) + s); }
    function sanitizeFileName(name){ let s = (name || "").trim(); s = s.replace(/[\/\\:\*\?"<>\|]/g, " "); return s.replace(/\s+/g, " ").trim(); }
    function ensureUniqueName(baseName, usedMap){
      const key = baseName.toLowerCase();
      if (!usedMap.has(key)){ usedMap.set(key, 1); return baseName; }
      const n = usedMap.get(key) + 1; usedMap.set(key, n); return `${baseName} (${n})`;
    }
    function readLines(text){ return (text || "").replace(/\r\n/g, "\n").split("\n").map(x => x.trim()); }
    function getMode(){ return document.querySelector('input[name="mode"]:checked').value; }

    [cite_start]// [cite: 317] Parsing logic
    function parsePageRanges(text, maxPage){
      const t = (text || "").trim(); if (!t) return [];
      const parts = t.split(",").map(x=>x.trim()).filter(Boolean);
      const out = new Set();
      for (const part of parts){
        const m = part.match(/^(\d+)\s*-\s*(\d+)$/);
        if (m){
          let a = parseInt(m[1],10); let b = parseInt(m[2],10);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a > b) [a,b] = [b,a];
          for (let i=a;i<=b;i++){ if (i>=1 && i<=maxPage) out.add(i); }
        } else {
          const n = parseInt(part,10); if (Number.isFinite(n) && n>=1 && n<=maxPage) out.add(n);
        }
      }
      return Array.from(out).sort((x,y)=>x-y);
    }
    [cite_start]// [cite: 320]
    function parseGroups(spec, maxPage){
      const s = (spec || "").trim(); if (!s) return [];
      const rawGroups = s.split("|").map(x=>x.trim()).filter(Boolean);
      const groups = [];
      for (const g of rawGroups){
        const pages = parsePageRanges(g, maxPage);
        if (pages.length) groups.push(pages);
      }
      return groups;
    }
    [cite_start]// [cite: 341]
    async function buildPdfBytesFromPages(srcDoc, pages1Based){
      const newDoc = await PDFLib.PDFDocument.create();
      const idx0 = pages1Based.map(p => p-1);
      const copied = await newDoc.copyPages(srcDoc, idx0);
      copied.forEach(pg => newDoc.addPage(pg));
      return await newDoc.save();
    }
    [cite_start]// [cite: 343]
    function pagesLabel(pages, width){
      if (!pages.length) return "p";
      const a = padNumber(pages[0], width);
      const b = padNumber(pages[pages.length-1], width);
      return (pages.length === 1) ? `p${a}` : `p${a}-${b}`;
    }

    // --- LOGIC MODAL (ƒê√É S·ª¨A GIAO DI·ªÜN) ---
    [cite_start]// [cite: 333]
    function askNamesForSingleSplit(pageCount){
      return new Promise((resolve) => {
        modalPageCount.textContent = String(pageCount);
        chkUseNames.checked = false;
        namesText.classList.add("hidden");
        namesText.value = "";
        nameModalOverlay.style.display = "flex";

        const onCancel = () => { cleanup(); nameModalOverlay.style.display = "none"; resolve(null); };
        const onContinue = () => {
          const useNames = chkUseNames.checked;
          const linesRaw = (namesText.value || "").replace(/\r\n/g, "\n").split("\n");
          cleanup(); nameModalOverlay.style.display = "none"; resolve({ useNames, linesRaw });
        };
        const onKey = (e) => { if (e.key === "Escape") onCancel(); };
        function cleanup(){
          btnModalCancel.removeEventListener("click", onCancel);
          btnModalContinue.removeEventListener("click", onContinue);
          document.removeEventListener("keydown", onKey);
        }
        btnModalCancel.addEventListener("click", onCancel);
        btnModalContinue.addEventListener("click", onContinue);
        document.addEventListener("keydown", onKey);
      });
    }
    chkUseNames.addEventListener("change", () => {
      const on = chkUseNames.checked;
      namesText.classList.toggle("hidden", !on);
      if(on) namesText.focus();
    });

    // --- S·ª∞ KI·ªÜN N√öT ---
    btnInfo.addEventListener("click", () => {
        alert(`Th√¥ng tin file:\n- T√™n: ${currentFile.name}\n- S·ªë trang: ${currentPageCount}`);
    });

    [cite_start]// [cite: 345] CORE SPLIT LOGIC
    btnSplit.addEventListener("click", async () => {
      if (!currentFile || !currentPdfBytes) return;

      logEl.innerHTML = ""; // Clear log
      btnSplit.disabled = true;
      progressWrap.style.display = "block";
      setStatus("ƒêang x·ª≠ l√Ω...", 10);

      try{
        const mode = getMode();
        const srcDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
        const pageCount = srcDoc.getPageCount();
        const width = String(pageCount).length;
        const baseFromFile = getBaseName(currentFile.name);
        const zip = new JSZip();
        const zipName = (zipNameInput.value || "").trim() || `${baseFromFile}_split.zip`;

        let groups = [];
        let singleNameLines = null;
        let useSingleNames = false;
        let customGroupNameLines = [];

        // MODE 1: SINGLE
        if (mode === "single"){
          const modalResult = await askNamesForSingleSplit(pageCount);
          if (!modalResult){
            setStatus("ƒê√£ hu·ª∑ thao t√°c");
            progressWrap.style.display = "none";
            btnSplit.disabled = false;
            return;
          }
          useSingleNames = modalResult.useNames;
          singleNameLines = modalResult.linesRaw;
          groups = Array.from({length: pageCount}, (_,i)=>[i+1]);
        }

        // MODE 2: CUSTOM
        if (mode === "custom"){
          const spec = (customSpec.value || "").trim();
          groups = parseGroups(spec, pageCount);
          if (!groups.length) throw new Error("B·∫°n ch∆∞a nh·∫≠p nh√≥m trang n√†o c·∫£!");
          customGroupNameLines = readLines(customNames.value || "");
        }

        // MODE 3: SIZE
        if (mode === "size"){
          const limitMB = Number(maxMB.value);
          if (!Number.isFinite(limitMB) || limitMB <= 0) throw new Error("Dung l∆∞·ª£ng gi·ªõi h·∫°n kh√¥ng h·ª£p l·ªá.");
          
          setStatus("ƒêang t√≠nh to√°n dung l∆∞·ª£ng...", 30);
          const maxBytes = Math.floor(limitMB * 1024 * 1024);
          let currentPages = [];
          let currentBytes = null;

          const finalizeCurrent = () => {
            if (currentPages.length && currentBytes) groups.push({ pages: currentPages.slice(), bytes: currentBytes });
          };

          for (let p = 1; p <= pageCount; p++){
            const candidatePages = currentPages.concat([p]);
            const candidateBytes = await buildPdfBytesFromPages(srcDoc, candidatePages);

            if (candidateBytes.length <= maxBytes || currentPages.length === 0){
              currentPages = candidatePages;
              currentBytes = candidateBytes;
            } else {
              finalizeCurrent();
              currentPages = [p];
              currentBytes = await buildPdfBytesFromPages(srcDoc, currentPages);
            }
            setStatus(`ƒêang qu√©t trang ${p}/${pageCount}...`, 30 + (p/pageCount)*20);
          }
          finalizeCurrent();
        }

        // --- EXPORT TO ZIP ---
        setStatus("ƒêang t·∫°o file PDF & n√©n...", 60);
        let outCount = 0;
        
        // Logic Size mode ri√™ng do ƒë√£ c√≥ bytes s·∫µn
        if (mode === "size"){
          const prefix = baseFromFile;
          for (let i = 0; i < groups.length; i++){
            const pages = groups[i].pages;
            const bytes = groups[i].bytes;
            const label = pagesLabel(pages, width);
            const fname = `${prefix}_part${padNumber(i+1, 2)}_${label}.pdf`;
            zip.file(fname, bytes);
            outCount++;
          }
        } else {
          // Logic Single & Custom
          const prefix = baseFromFile;
          const usedNames = new Map();

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i];
            const bytes = await buildPdfBytesFromPages(srcDoc, pages);
            
            let fnameBase;
            if (mode === "single" && useSingleNames) {
                const raw = (singleNameLines && singleNameLines[pages[0]-1]) ? singleNameLines[pages[0]-1] : "";
                const cleaned = sanitizeFileName(raw).replace(/\.pdf$/i, "").trim();
                fnameBase = cleaned ? ensureUniqueName(cleaned, usedNames) : `${prefix}_${pagesLabel(pages, width)}`;
            } else if (mode === "custom") {
                const raw = (customGroupNameLines && customGroupNameLines[i]) ? customGroupNameLines[i] : "";
                const cleaned = sanitizeFileName(raw).replace(/\.pdf$/i, "").trim();
                fnameBase = cleaned ? ensureUniqueName(cleaned, usedNames) : `${prefix}_${padNumber(i+1, 2)}_${pagesLabel(pages, width)}`;
            } else {
                fnameBase = `${prefix}_${pagesLabel(pages, width)}`;
            }
            
            zip.file(`${fnameBase}.pdf`, bytes);
            outCount++;
            
            // Update bar visual
            const pct = 60 + Math.round(((i+1)/groups.length) * 30);
            setStatus(`ƒêang n√©n file ${i+1}/${groups.length}`, pct);
          }
        }

        setStatus("ƒêang ho√†n t·∫•t...", 95);
        const zipBlob = await zip.generateAsync({ type: "blob" });
        downloadBlob(zipBlob, zipName);
        
        setStatus("Th√†nh c√¥ng! File ƒëang t·∫£i xu·ªëng.", 100);
        log(`ƒê√£ t√°ch th√†nh ${outCount} file.`);
        
      } catch (e){
        setStatus("C√≥ l·ªói x·∫£y ra!", 0);
        log(String(e), "err");
        alert("L·ªói: " + e.message);
      } finally {
        btnSplit.disabled = false;
      }
    });
</script>
</body>
</html>
