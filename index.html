<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>T√°ch PDF: T√°ch l·∫ª | Theo y√™u c·∫ßu | Theo dung l∆∞·ª£ng + ZIP</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;box-shadow:0 16px 36px rgba(0,0,0,.35)}
    h1{font-size:20px;margin:0 0 8px}
    p{margin:0 0 14px;color:#94a3b8;line-height:1.5}
    .grid{display:grid;gap:12px;grid-template-columns:1.2fr .8fr}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    input[type="file"], input[type="text"], input[type="number"], textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);color:#e5e7eb;outline:none
    }
    textarea{min-height:220px;resize:vertical}
    .modes{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 4px}
    .mode{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05)
    }
    .mode input{margin-top:3px}
    .mode b{display:block}
    .hint{font-size:13px;color:#94a3b8;margin-top:6px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
    button{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.16);
      background:#2563eb;color:#fff;cursor:pointer;font-weight:700
    }
    button.secondary{background:rgba(255,255,255,.08)}
    button.danger{background:rgba(239,68,68,.20)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .progress{margin-top:14px;height:10px;background:rgba(255,255,255,.10);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.10)}
    .bar{height:100%;width:0%;background:#22c55e;transition:width .15s ease}
    .meta{margin-top:10px;color:#cbd5e1;font-size:14px}
    .log{
      margin-top:12px;padding:12px;border-radius:12px;background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:13px;color:#e5e7eb;max-height:280px;overflow:auto
    }
    .ok{color:#86efac}
    .err{color:#fca5a5}
    .row2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:820px){.row2{grid-template-columns:1fr}}
    .hide{display:none !important}
    a{color:#93c5fd}

    /* ===== Modal ===== */
    .modal-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modal{
      width:min(860px, 100%);
      background:#0f172a;
      border:1px solid rgba(255,255,255,.14);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .modal header b{font-size:15px}
    .modal .content{padding:14px 16px}
    .modal .content .note{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:#cbd5e1;
      font-size:13px;
      line-height:1.4;
      margin-bottom:10px;
    }
    .modal .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin:10px 0;
    }
    .modal footer{
      padding:12px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-size:13px;
      color:#e5e7eb;
    }
    .pill input{margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>T√°ch PDF ‚Üí nhi·ªÅu file PDF ‚Üí n√©n ZIP</h1>
      <p>
        Ch·ªçn PDF, ch·ªçn ch·∫ø ƒë·ªô t√°ch, b·∫•m <b>T√°ch & T·∫£i ZIP</b>.
        (D√πng <b>pdf-lib</b> + <b>JSZip</b> qua CDN.)
      </p>

      <div class="grid">
        <div>
          <input id="file" type="file" accept="application/pdf" />
          <div class="hint">PDF scan n·∫∑ng c√≥ th·ªÉ ch·∫°y ch·∫≠m do gi·ªõi h·∫°n RAM tr√¨nh duy·ªát.</div>
        </div>
        <div>
          <input id="zipname" type="text" placeholder="T√™n ZIP (tu·ª≥ ch·ªçn) - ƒë·ªÉ tr·ªëng = t·ª± ƒë·∫∑t" />
          <div class="hint">V√≠ d·ª•: split_ho_so_001.zip</div>
        </div>
      </div>

      <div class="modes">
        <label class="mode">
          <input type="radio" name="mode" value="single" checked />
          <div>
            <b>Ch·ªçn t√°ch l·∫ª</b>
            <div class="hint">M·ªói trang 1 file PDF. (S·∫Ω h·ªèi c√≥ mu·ªën ƒë·∫∑t t√™n t·ª´ng file hay kh√¥ng.)</div>
          </div>
        </label>

        <label class="mode">
          <input type="radio" name="mode" value="custom" />
          <div>
            <b>T√°ch theo y√™u c·∫ßu</b>
            <div class="hint">B·∫°n t·ª± nh·∫≠p nh√≥m trang (vd: 1-3|4-6|7,9|10).</div>
          </div>
        </label>

        <label class="mode">
          <input type="radio" name="mode" value="size" />
          <div>
            <b>T√°ch theo dung l∆∞·ª£ng</b>
            <div class="hint">T·ª± chia sao cho m·ªói file ‚â§ X MB (tr·ª´ trang ƒë∆°n l·∫ª qu√° l·ªõn).</div>
          </div>
        </label>
      </div>

      <div id="customBox" class="row2 hide">
        <div>
          <input id="customSpec" type="text" placeholder="Nh·∫≠p nh√≥m trang: 1-3|4-6|7,9|10" />
          <div class="hint">
            D√πng <b>|</b> ƒë·ªÉ ngƒÉn nh√≥m. Trong m·ªói nh√≥m c√≥ th·ªÉ d√πng <b>,</b> v√† <b>-</b>.<br/>
            V√≠ d·ª•: <b>1-5|6-10</b> s·∫Ω ra 2 file.
          </div>
        </div>
        <div>
          <input id="customPrefix" type="text" placeholder="Ti·ªÅn t·ªë t√™n file (tu·ª≥ ch·ªçn) - vd: HO_SO" />
          <div class="hint">N·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng t√™n PDF g·ªëc.</div>
        </div>
      </div>

      <div id="sizeBox" class="row2 hide">
        <div>
          <input id="maxMB" type="number" min="0.1" step="0.1" value="5" />
          <div class="hint">Gi·ªõi h·∫°n dung l∆∞·ª£ng m·ªói file (MB). V√≠ d·ª• 5 MB.</div>
        </div>
        <div>
          <input id="sizePrefix" type="text" placeholder="Ti·ªÅn t·ªë t√™n file (tu·ª≥ ch·ªçn) - vd: PART" />
          <div class="hint">N·∫øu ƒë·ªÉ tr·ªëng s·∫Ω d√πng t√™n PDF g·ªëc.</div>
        </div>
      </div>

      <div class="btns">
        <button id="btnSplit" disabled>T√°ch & T·∫£i ZIP</button>
        <button id="btnInfo" class="secondary" disabled>Xem th√¥ng tin PDF</button>
        <span id="status" style="color:#cbd5e1;font-size:14px"></span>
      </div>

      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="meta" id="meta"></div>
      <div class="log" id="log"></div>

      <div class="hint" style="margin-top:10px">
        L∆∞u √Ω ch·∫ø ƒë·ªô dung l∆∞·ª£ng: ch∆∞∆°ng tr√¨nh <b>ƒëo k√≠ch th∆∞·ªõc file PDF t·∫°o ra th·ª±c t·∫ø</b> ƒë·ªÉ quy·∫øt ƒë·ªãnh c·∫Øt,
        n√™n ƒëa s·ªë file s·∫Ω ‚â§ X MB. N·∫øu <b>1 trang</b> ƒë√£ > X MB th√¨ b·∫Øt bu·ªôc file ƒë√≥ v·∫´n > X MB.
      </div>
    </div>
  </div>

  <!-- ===== Modal ƒë·∫∑t t√™n t·ª´ng trang (ch·ªâ d√πng cho t√°ch l·∫ª) ===== -->
  <div class="modal-overlay" id="nameModalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <b>ƒê·∫∑t t√™n file khi t√°ch l·∫ª t·ª´ng trang</b>
        <span class="pill"><span>Trang:</span> <b id="modalPageCount">0</b></span>
      </header>
      <div class="content">
        <div class="note">
          ‚úÖ N·∫øu b·∫°n ch·ªçn ƒë·∫∑t t√™n: <b>m·ªói d√≤ng = 1 file</b> (t∆∞∆°ng ·ª©ng theo <b>th·ª© t·ª± trang</b> t·ª´ 1 ‚Üí n).<br/>
          üìå <b>Ghi ch√∫:</b> N·∫øu l√† <b>file scan</b>, nh·ªõ s·∫Øp x·∫øp/ki·ªÉm tra ƒë√∫ng th·ª© t·ª± trang ƒë·ªÉ kh·ªõp v·ªõi danh s√°ch t√™n n√†y.
        </div>

        <div class="controls">
          <label class="pill">
            <input type="checkbox" id="chkUseNames" />
            <span>B·∫≠t ƒë·∫∑t t√™n theo danh s√°ch</span>
          </label>
          <span class="hint" style="margin:0">N·∫øu t·∫Øt: s·∫Ω t·ª± ƒë·∫∑t t√™n theo d·∫°ng <b>tenPDF_p01.pdf</b>, <b>tenPDF_p02.pdf</b>‚Ä¶</span>
        </div>

        <textarea id="namesText" class="hide" placeholder="D√°n danh s√°ch t√™n t·∫°i ƒë√¢y...
V√≠ d·ª•:
CMND_NguyenVanA
SoHoKhau_NguyenVanA
GiayDangKyKetHon
...
(m·ªói d√≤ng l√† 1 t√™n)"></textarea>

        <div class="hint" id="namesHint"></div>
      </div>
      <footer>
        <button class="secondary" id="btnModalCancel">Hu·ª∑</button>
        <button id="btnModalContinue">Ti·∫øp t·ª•c</button>
      </footer>
    </div>
  </div>

  <!-- pdf-lib -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <!-- JSZip -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    const fileInput = $("file");
    const zipNameInput = $("zipname");

    const customBox = $("customBox");
    const sizeBox   = $("sizeBox");
    const customSpec = $("customSpec");
    const customPrefix = $("customPrefix");
    const maxMB = $("maxMB");
    const sizePrefix = $("sizePrefix");

    const btnSplit = $("btnSplit");
    const btnInfo  = $("btnInfo");
    const statusEl = $("status");
    const metaEl   = $("meta");
    const logEl    = $("log");
    const barEl    = $("bar");

    // Modal
    const nameModalOverlay = $("nameModalOverlay");
    const modalPageCount = $("modalPageCount");
    const chkUseNames = $("chkUseNames");
    const namesText = $("namesText");
    const namesHint = $("namesHint");
    const btnModalCancel = $("btnModalCancel");
    const btnModalContinue = $("btnModalContinue");

    let currentFile = null;
    let currentPdfBytes = null;
    let currentPageCount = 0;

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setBar(pct){ barEl.style.width = Math.max(0, Math.min(100, pct)) + "%"; }
    function clearLog(){ logEl.textContent = ""; metaEl.textContent = ""; setBar(0); setStatus(""); }
    function log(msg, cls){
      const line = document.createElement("div");
      if (cls) line.className = cls;
      line.textContent = msg;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
    }

    function getBaseName(name){ return (name || "file").replace(/\.[^.]+$/,""); }
    function padNumber(n, width){
      const s = String(n);
      return s.length >= width ? s : ("0".repeat(width - s.length) + s);
    }

    function sanitizeFileName(name){
      // lo·∫°i k√Ω t·ª± c·∫•m trong t√™n file Windows/macOS
      let s = (name || "").trim();
      s = s.replace(/[\/\\:\*\?"<>\|]/g, " ");
      s = s.replace(/\s+/g, " ").trim();
      return s;
    }

    function ensureUniqueName(baseName, usedMap){
      const key = baseName.toLowerCase();
      if (!usedMap.has(key)){
        usedMap.set(key, 1);
        return baseName;
      }
      const n = usedMap.get(key) + 1;
      usedMap.set(key, n);
      return `${baseName} (${n})`;
    }

    // Parse "1-3,5,7-10" => [1,2,3,5,7,8,9,10]
    function parsePageRanges(text, maxPage){
      const t = (text || "").trim();
      if (!t) return [];
      const parts = t.split(",").map(x=>x.trim()).filter(Boolean);
      const out = new Set();

      for (const part of parts){
        const m = part.match(/^(\d+)\s*-\s*(\d+)$/);
        if (m){
          let a = parseInt(m[1],10);
          let b = parseInt(m[2],10);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a > b) [a,b] = [b,a];
          for (let i=a;i<=b;i++){
            if (i>=1 && i<=maxPage) out.add(i);
          }
        } else {
          const n = parseInt(part,10);
          if (Number.isFinite(n) && n>=1 && n<=maxPage) out.add(n);
        }
      }
      return Array.from(out).sort((x,y)=>x-y);
    }

    // "1-3|4-6|7,9|10" => [[1,2,3],[4,5,6],[7,9],[10]]
    function parseGroups(spec, maxPage){
      const s = (spec || "").trim();
      if (!s) return [];
      const rawGroups = s.split("|").map(x=>x.trim()).filter(Boolean);
      const groups = [];
      for (const g of rawGroups){
        const pages = parsePageRanges(g, maxPage);
        if (pages.length) groups.push(pages);
      }
      return groups;
    }

    async function loadPdfFromFile(file){
      const buf = await file.arrayBuffer();
      currentPdfBytes = new Uint8Array(buf);
      const pdfDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
      currentPageCount = pdfDoc.getPageCount();
      return pdfDoc;
    }

    function getMode(){
      const el = document.querySelector('input[name="mode"]:checked');
      return el ? el.value : "single";
    }

    function refreshModeUI(){
      const mode = getMode();
      customBox.classList.toggle("hide", mode !== "custom");
      sizeBox.classList.toggle("hide", mode !== "size");
    }
    document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", refreshModeUI));
    refreshModeUI();

    // ===== Modal logic =====
    function openNameModal(pageCount){
      modalPageCount.textContent = String(pageCount);
      chkUseNames.checked = false;
      namesText.value = "";
      namesText.classList.add("hide");
      namesHint.textContent = "";
      nameModalOverlay.style.display = "flex";

      // focus UX
      setTimeout(() => btnModalContinue.focus(), 50);
    }

    function closeNameModal(){
      nameModalOverlay.style.display = "none";
    }

    chkUseNames.addEventListener("change", () => {
      const on = chkUseNames.checked;
      namesText.classList.toggle("hide", !on);
      namesHint.textContent = on
        ? "M·∫πo: B·∫°n c√≥ th·ªÉ copy t·ª´ Excel/Word: m·ªói d√≤ng 1 t√™n. N·∫øu d√≤ng n√†o ƒë·ªÉ tr·ªëng ‚Üí file ƒë√≥ s·∫Ω d√πng t√™n m·∫∑c ƒë·ªãnh."
        : "";
      if (on) setTimeout(() => namesText.focus(), 50);
    });

    // Tr·∫£ v·ªÅ Promise: null = user h·ªßy; {useNames:boolean, lines:string[]} = ti·∫øp t·ª•c
    function askNamesForSingleSplit(pageCount){
      return new Promise((resolve) => {
        openNameModal(pageCount);

        const onCancel = () => {
          cleanup();
          closeNameModal();
          resolve(null);
        };

        const onContinue = () => {
          const useNames = chkUseNames.checked;
          const linesRaw = (namesText.value || "").replace(/\r\n/g, "\n").split("\n");
          cleanup();
          closeNameModal();
          resolve({ useNames, linesRaw });
        };

        const onKey = (e) => {
          if (e.key === "Escape") onCancel();
        };

        function cleanup(){
          btnModalCancel.removeEventListener("click", onCancel);
          btnModalContinue.removeEventListener("click", onContinue);
          document.removeEventListener("keydown", onKey);
        }

        btnModalCancel.addEventListener("click", onCancel);
        btnModalContinue.addEventListener("click", onContinue);
        document.addEventListener("keydown", onKey);
      });
    }

    fileInput.addEventListener("change", async () => {
      clearLog();
      const f = fileInput.files && fileInput.files[0];
      currentFile = f || null;

      btnSplit.disabled = true;
      btnInfo.disabled = true;

      if (!currentFile){ return; }

      setStatus("ƒêang ƒë·ªçc PDF...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("S·∫µn s√†ng");
        btnSplit.disabled = false;
        btnInfo.disabled = false;

        metaEl.textContent =
          `T√™n file: ${currentFile.name} | Dung l∆∞·ª£ng: ${(currentFile.size/1024/1024).toFixed(2)} MB | S·ªë trang: ${currentPageCount}`;
        log("ƒê√£ t·∫£i PDF th√†nh c√¥ng.", "ok");
      } catch (e){
        setStatus("L·ªói ƒë·ªçc PDF");
        log("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c PDF. C√≥ th·ªÉ file b·ªã m√£ ho√° ho·∫∑c h·ªèng.", "err");
        log(String(e), "err");
      }
    });

    btnInfo.addEventListener("click", async () => {
      if (!currentFile) return;
      clearLog();
      setStatus("ƒêang l·∫•y th√¥ng tin...");
      try{
        await loadPdfFromFile(currentFile);
        setStatus("Xong");
        metaEl.textContent = `S·ªë trang: ${currentPageCount}`;
        log(`PDF c√≥ ${currentPageCount} trang.`, "ok");
        log(`V√≠ d·ª• theo y√™u c·∫ßu: 1-3|4-6|7,9|10`);
        log(`V√≠ d·ª• theo dung l∆∞·ª£ng: nh·∫≠p 5 (MB) ƒë·ªÉ chia m·ªói file <= 5MB.`);
      } catch (e){
        setStatus("L·ªói");
        log(String(e), "err");
      }
    });

    async function buildPdfBytesFromPages(srcDoc, pages1Based){
      const newDoc = await PDFLib.PDFDocument.create();
      const idx0 = pages1Based.map(p => p-1);
      const copied = await newDoc.copyPages(srcDoc, idx0);
      copied.forEach(pg => newDoc.addPage(pg));
      const bytes = await newDoc.save();
      return bytes;
    }

    function pagesLabel(pages, width){
      if (!pages.length) return "p";
      const a = padNumber(pages[0], width);
      const b = padNumber(pages[pages.length-1], width);
      return (pages.length === 1) ? `p${a}` : `p${a}-${b}`;
    }

    btnSplit.addEventListener("click", async () => {
      if (!currentFile || !currentPdfBytes) return;

      clearLog();
      btnSplit.disabled = true;
      btnInfo.disabled = true;

      try{
        const mode = getMode();
        setStatus("ƒêang m·ªü PDF...");
        const srcDoc = await PDFLib.PDFDocument.load(currentPdfBytes, { ignoreEncryption: false });
        const pageCount = srcDoc.getPageCount();
        const width = String(pageCount).length;

        const baseFromFile = getBaseName(currentFile.name);
        const zip = new JSZip();

        const zipName = (zipNameInput.value || "").trim() || `${baseFromFile}_split.zip`;

        log(`Ch·∫ø ƒë·ªô: ${mode}`, "ok");
        log(`T·ªïng trang: ${pageCount}`, "ok");

        // ===== 1) X√¢y groups theo mode =====
        let groups = [];

        // Names list for single mode (optional)
        let singleNameLines = null;   // raw lines
        let useSingleNames = false;

        if (mode === "single"){
          // h·ªèi ƒë·∫∑t t√™n tr∆∞·ªõc khi t√°ch
          const modalResult = await askNamesForSingleSplit(pageCount);
          if (!modalResult){
            setStatus("ƒê√£ hu·ª∑");
            log("B·∫°n ƒë√£ hu·ª∑ thao t√°c.", "err");
            return;
          }
          useSingleNames = modalResult.useNames;
          singleNameLines = modalResult.linesRaw;

          if (useSingleNames){
            log("ƒêang d√πng danh s√°ch t√™n (m·ªói d√≤ng = 1 trang).", "ok");
            log("Ghi ch√∫: File scan nh·ªõ ƒë√∫ng th·ª© t·ª± trang ƒë·ªÉ kh·ªõp t√™n.", "ok");
          } else {
            log("Kh√¥ng ƒë·∫∑t t√™n theo danh s√°ch ‚Üí d√πng t√™n m·∫∑c ƒë·ªãnh.", "ok");
          }

          groups = Array.from({length: pageCount}, (_,i)=>[i+1]);
        }

        if (mode === "custom"){
          const spec = (customSpec.value || "").trim();
          groups = parseGroups(spec, pageCount);
          if (!groups.length){
            throw new Error("Ch·∫ø ƒë·ªô 'theo y√™u c·∫ßu' c·∫ßn nh·∫≠p nh√≥m trang. V√≠ d·ª•: 1-3|4-6|7,9|10");
          }
        }

        if (mode === "size"){
          const limitMB = Number(maxMB.value);
          if (!Number.isFinite(limitMB) || limitMB <= 0) {
            throw new Error("Dung l∆∞·ª£ng (MB) kh√¥ng h·ª£p l·ªá.");
          }
          const maxBytes = Math.floor(limitMB * 1024 * 1024);

          let currentPages = [];
          let currentBytes = null;

          const finalizeCurrent = () => {
            if (currentPages.length && currentBytes) {
              groups.push({ pages: currentPages.slice(), bytes: currentBytes });
            }
          };

          setStatus("ƒêang chia nh√≥m theo dung l∆∞·ª£ng...");
          for (let p = 1; p <= pageCount; p++){
            const candidatePages = currentPages.concat([p]);
            const candidateBytes = await buildPdfBytesFromPages(srcDoc, candidatePages);

            if (candidateBytes.length <= maxBytes || currentPages.length === 0){
              currentPages = candidatePages;
              currentBytes = candidateBytes;

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);

              if (candidateBytes.length > maxBytes && currentPages.length === 1){
                log(`Trang ${p} ri√™ng l·∫ª ƒë√£ ${(candidateBytes.length/1024/1024).toFixed(2)} MB > ${limitMB} MB (b·∫Øt bu·ªôc).`, "err");
              }
            } else {
              finalizeCurrent();
              currentPages = [p];
              currentBytes = await buildPdfBytesFromPages(srcDoc, currentPages);

              const pct = Math.round((p / pageCount) * 55);
              setBar(pct);
            }
          }
          finalizeCurrent();

          log(`ƒê√£ chia th√†nh ${groups.length} file theo dung l∆∞·ª£ng ~‚â§ ${limitMB} MB.`, "ok");
        }

        // ===== 2) Xu·∫•t file v√†o ZIP =====
        setStatus("ƒêang t·∫°o file & ƒë∆∞a v√†o ZIP...");
        let outCount = 0;

        if (mode === "size"){
          const prefix = (sizePrefix.value || "").trim() || baseFromFile;

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i].pages;
            const bytes = groups[i].bytes;
            const label = pagesLabel(pages, width);
            const fname = `${prefix}_${padNumber(i+1, 2)}_${label}.pdf`;

            zip.file(fname, bytes);
            outCount++;

            const pct = 55 + Math.round(((i+1)/groups.length) * 30);
            setBar(pct);

            log(`+ ${fname} (${(bytes.length/1024/1024).toFixed(2)} MB)`);
          }
        } else {
          const prefix = (mode === "custom")
            ? ((customPrefix.value || "").trim() || baseFromFile)
            : baseFromFile;

          const usedNames = new Map();

          for (let i = 0; i < groups.length; i++){
            const pages = groups[i];
            const bytes = await buildPdfBytesFromPages(srcDoc, pages);

            let fnameBase;

            if (mode === "single") {
              // pages = [pageNo]
              const pageNo = pages[0];

              if (useSingleNames) {
                // l·∫•y d√≤ng t∆∞∆°ng ·ª©ng (1-based)
                const raw = (singleNameLines && singleNameLines[pageNo - 1]) ? singleNameLines[pageNo - 1] : "";
                const cleaned = sanitizeFileName(raw).replace(/\.pdf$/i, "").trim();

                if (cleaned) {
                  fnameBase = ensureUniqueName(cleaned, usedNames);
                } else {
                  fnameBase = `${prefix}_${pagesLabel(pages, width)}`;
                }
              } else {
                fnameBase = `${prefix}_${pagesLabel(pages, width)}`;
              }

              const fname = `${fnameBase}.pdf`;
              zip.file(fname, bytes);
              outCount++;

              const pct = 55 + Math.round(((i+1)/groups.length) * 30);
              setBar(pct);

              if ((i+1) % 5 === 0 || i === groups.length - 1) log(`ƒê√£ t·∫°o ${i+1}/${groups.length} file...`);
            } else {
              // custom groups
              const fname = `${prefix}_${padNumber(i+1, 2)}_${pagesLabel(pages, width)}.pdf`;
              zip.file(fname, bytes);
              outCount++;

              const pct = 55 + Math.round(((i+1)/groups.length) * 30);
              setBar(pct);

              if ((i+1) % 3 === 0 || i === groups.length - 1) log(`ƒê√£ t·∫°o ${i+1}/${groups.length} file...`);
            }
          }
        }

        // ===== 3) N√©n ZIP v√† t·∫£i xu·ªëng =====
        setStatus("ƒêang n√©n ZIP...");
        setBar(90);

        const zipBlob = await zip.generateAsync({ type: "blob" }, (meta) => {
          const pct = 90 + Math.round((meta.percent/100)*10);
          setBar(pct);
        });

        downloadBlob(zipBlob, zipName);
        setStatus("Ho√†n t·∫•t ‚úÖ");
        setBar(100);
        log(`ƒê√£ t·∫°o ${outCount} file PDF v√† n√©n v√†o: ${zipName}`, "ok");

      } catch (e){
        setStatus("C√≥ l·ªói ‚ùå");
        log("L·ªói:", "err");
        log(String(e), "err");
      } finally {
        btnSplit.disabled = false;
        btnInfo.disabled = false;
      }
    });
  </script>
</body>
</html>
